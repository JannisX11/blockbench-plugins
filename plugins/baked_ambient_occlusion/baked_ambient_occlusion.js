/*! For license information please see baked_ambient_occlusion.js.LICENSE.txt */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var s=e();for(var i in s)("object"==typeof exports?exports:t)[i]=s[i]}}(this,()=>(()=>{"use strict";const t="182",e=2300,s=2301,i=2302,r="srgb",n="srgb-linear",a="linear",o="srgb";function h(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;const l={};function c(...t){const e="THREE."+t.shift();console.warn(e,...t)}function u(...t){const e="THREE."+t.shift();console.error(e,...t)}function d(...t){const e=t.join(" ");e in l||(l[e]=!0,c(...t))}class p{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const s=this._listeners;void 0===s[t]&&(s[t]=[]),-1===s[t].indexOf(e)&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return void 0!==s&&void 0!==s[t]&&-1!==s[t].indexOf(e)}removeEventListener(t,e){const s=this._listeners;if(void 0===s)return;const i=s[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){const e=this._listeners;if(void 0===e)return;const s=e[t.type];if(void 0!==s){t.target=this;const e=s.slice(0);for(let s=0,i=e.length;s<i;s++)e[s].call(this,t);t.target=null}}}const m=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function y(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(m[255&t]+m[t>>8&255]+m[t>>16&255]+m[t>>24&255]+"-"+m[255&e]+m[e>>8&255]+"-"+m[e>>16&15|64]+m[e>>24&255]+"-"+m[63&s|128]+m[s>>8&255]+"-"+m[s>>16&255]+m[s>>24&255]+m[255&i]+m[i>>8&255]+m[i>>16&255]+m[i>>24&255]).toLowerCase()}function f(t,e,s){return Math.max(e,Math.min(s,t))}function x(t,e,s){return(1-s)*t+s*e}function g(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function b(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}Math.PI,Math.PI;class w{constructor(t=0,e=0){w.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6],this.y=i[1]*e+i[4]*s+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=f(this.x,t.x,e.x),this.y=f(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=f(this.x,t,e),this.y=f(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(f(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(f(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),i=Math.sin(e),r=this.x-t.x,n=this.y-t.y;return this.x=r*s-n*i+t.x,this.y=r*i+n*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class _{constructor(t=0,e=0,s=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=i}static slerpFlat(t,e,s,i,r,n,a){let o=s[i+0],h=s[i+1],l=s[i+2],c=s[i+3],u=r[n+0],d=r[n+1],p=r[n+2],m=r[n+3];if(a<=0)return t[e+0]=o,t[e+1]=h,t[e+2]=l,void(t[e+3]=c);if(a>=1)return t[e+0]=u,t[e+1]=d,t[e+2]=p,void(t[e+3]=m);if(c!==m||o!==u||h!==d||l!==p){let t=o*u+h*d+l*p+c*m;t<0&&(u=-u,d=-d,p=-p,m=-m,t=-t);let e=1-a;if(t<.9995){const s=Math.acos(t),i=Math.sin(s);e=Math.sin(e*s)/i,o=o*e+u*(a=Math.sin(a*s)/i),h=h*e+d*a,l=l*e+p*a,c=c*e+m*a}else{o=o*e+u*a,h=h*e+d*a,l=l*e+p*a,c=c*e+m*a;const t=1/Math.sqrt(o*o+h*h+l*l+c*c);o*=t,h*=t,l*=t,c*=t}}t[e]=o,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,s,i,r,n){const a=s[i],o=s[i+1],h=s[i+2],l=s[i+3],c=r[n],u=r[n+1],d=r[n+2],p=r[n+3];return t[e]=a*p+l*c+o*d-h*u,t[e+1]=o*p+l*u+h*c-a*d,t[e+2]=h*p+l*d+a*u-o*c,t[e+3]=l*p-a*c-o*u-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,i=t._y,r=t._z,n=t._order,a=Math.cos,o=Math.sin,h=a(s/2),l=a(i/2),u=a(r/2),d=o(s/2),p=o(i/2),m=o(r/2);switch(n){case"XYZ":this._x=d*l*u+h*p*m,this._y=h*p*u-d*l*m,this._z=h*l*m+d*p*u,this._w=h*l*u-d*p*m;break;case"YXZ":this._x=d*l*u+h*p*m,this._y=h*p*u-d*l*m,this._z=h*l*m-d*p*u,this._w=h*l*u+d*p*m;break;case"ZXY":this._x=d*l*u-h*p*m,this._y=h*p*u+d*l*m,this._z=h*l*m+d*p*u,this._w=h*l*u-d*p*m;break;case"ZYX":this._x=d*l*u-h*p*m,this._y=h*p*u+d*l*m,this._z=h*l*m-d*p*u,this._w=h*l*u+d*p*m;break;case"YZX":this._x=d*l*u+h*p*m,this._y=h*p*u+d*l*m,this._z=h*l*m-d*p*u,this._w=h*l*u-d*p*m;break;case"XZY":this._x=d*l*u-h*p*m,this._y=h*p*u-d*l*m,this._z=h*l*m+d*p*u,this._w=h*l*u+d*p*m;break;default:c("Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],r=e[8],n=e[1],a=e[5],o=e[9],h=e[2],l=e[6],c=e[10],u=s+a+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-o)*t,this._y=(r-h)*t,this._z=(n-i)*t}else if(s>a&&s>c){const t=2*Math.sqrt(1+s-a-c);this._w=(l-o)/t,this._x=.25*t,this._y=(i+n)/t,this._z=(r+h)/t}else if(a>c){const t=2*Math.sqrt(1+a-s-c);this._w=(r-h)/t,this._x=(i+n)/t,this._y=.25*t,this._z=(o+l)/t}else{const t=2*Math.sqrt(1+c-s-a);this._w=(n-i)/t,this._x=(r+h)/t,this._y=(o+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<1e-8?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(f(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(0===s)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,r=t._z,n=t._w,a=e._x,o=e._y,h=e._z,l=e._w;return this._x=s*l+n*a+i*h-r*o,this._y=i*l+n*o+r*a-s*h,this._z=r*l+n*h+s*o-i*a,this._w=n*l-s*a-i*o-r*h,this._onChangeCallback(),this}slerp(t,e){if(e<=0)return this;if(e>=1)return this.copy(t);let s=t._x,i=t._y,r=t._z,n=t._w,a=this.dot(t);a<0&&(s=-s,i=-i,r=-r,n=-n,a=-a);let o=1-e;if(a<.9995){const t=Math.acos(a),h=Math.sin(t);o=Math.sin(o*t)/h,e=Math.sin(e*t)/h,this._x=this._x*o+s*e,this._y=this._y*o+i*e,this._z=this._z*o+r*e,this._w=this._w*o+n*e,this._onChangeCallback()}else this._x=this._x*o+s*e,this._y=this._y*o+i*e,this._z=this._z*o+r*e,this._w=this._w*o+n*e,this.normalize();return this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(i*Math.sin(t),i*Math.cos(t),r*Math.sin(e),r*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class M{constructor(t=0,e=0,s=0){M.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return void 0===s&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(S.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(S.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*i,this.y=r[1]*e+r[4]*s+r[7]*i,this.z=r[2]*e+r[5]*s+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,n=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*n,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*n,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*n,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,r=t.x,n=t.y,a=t.z,o=t.w,h=2*(n*i-a*s),l=2*(a*e-r*i),c=2*(r*s-n*e);return this.x=e+o*h+n*c-a*l,this.y=s+o*l+a*h-r*c,this.z=i+o*c+r*l-n*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=f(this.x,t.x,e.x),this.y=f(this.y,t.y,e.y),this.z=f(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=f(this.x,t,e),this.y=f(this.y,t,e),this.z=f(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(f(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,n=e.x,a=e.y,o=e.z;return this.x=i*o-r*a,this.y=r*n-s*o,this.z=s*a-i*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return z.copy(this).projectOnVector(t),this.sub(z)}reflect(t){return this.sub(z.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(f(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const z=new M,S=new _;class A{constructor(t,e,s,i,r,n,a,o,h){A.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,s,i,r,n,a,o,h)}set(t,e,s,i,r,n,a,o,h){const l=this.elements;return l[0]=t,l[1]=i,l[2]=a,l[3]=e,l[4]=r,l[5]=o,l[6]=s,l[7]=n,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],a=s[3],o=s[6],h=s[1],l=s[4],c=s[7],u=s[2],d=s[5],p=s[8],m=i[0],y=i[3],f=i[6],x=i[1],g=i[4],b=i[7],w=i[2],_=i[5],M=i[8];return r[0]=n*m+a*x+o*w,r[3]=n*y+a*g+o*_,r[6]=n*f+a*b+o*M,r[1]=h*m+l*x+c*w,r[4]=h*y+l*g+c*_,r[7]=h*f+l*b+c*M,r[2]=u*m+d*x+p*w,r[5]=u*y+d*g+p*_,r[8]=u*f+d*b+p*M,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*n*l-e*a*h-s*r*l+s*a*o+i*r*h-i*n*o}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=l*n-a*h,u=a*o-l*r,d=h*r-n*o,p=e*c+s*u+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return t[0]=c*m,t[1]=(i*h-l*s)*m,t[2]=(a*s-i*n)*m,t[3]=u*m,t[4]=(l*e-i*o)*m,t[5]=(i*r-a*e)*m,t[6]=d*m,t[7]=(s*o-h*e)*m,t[8]=(n*e-s*r)*m,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,r,n,a){const o=Math.cos(r),h=Math.sin(r);return this.set(s*o,s*h,-s*(o*n+h*a)+n+t,-i*h,i*o,-i*(-h*n+o*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(v.makeScale(t,e)),this}rotate(t){return this.premultiply(v.makeRotation(-t)),this}translate(t,e){return this.premultiply(v.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const v=new A,T=(new A).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),B=(new A).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function k(){const t={enabled:!0,workingColorSpace:n,spaces:{},convert:function(t,e,s){return!1!==this.enabled&&e!==s&&e&&s?(this.spaces[e].transfer===o&&(t.r=C(t.r),t.g=C(t.g),t.b=C(t.b)),this.spaces[e].primaries!==this.spaces[s].primaries&&(t.applyMatrix3(this.spaces[e].toXYZ),t.applyMatrix3(this.spaces[s].fromXYZ)),this.spaces[s].transfer===o&&(t.r=V(t.r),t.g=V(t.g),t.b=V(t.b)),t):t},workingToColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},colorSpaceToWorking:function(t,e){return this.convert(t,e,this.workingColorSpace)},getPrimaries:function(t){return this.spaces[t].primaries},getTransfer:function(t){return""===t?a:this.spaces[t].transfer},getToneMappingMode:function(t){return this.spaces[t].outputColorSpaceConfig.toneMappingMode||"standard"},getLuminanceCoefficients:function(t,e=this.workingColorSpace){return t.fromArray(this.spaces[e].luminanceCoefficients)},define:function(t){Object.assign(this.spaces,t)},_getMatrix:function(t,e,s){return t.copy(this.spaces[e].toXYZ).multiply(this.spaces[s].fromXYZ)},_getDrawingBufferColorSpace:function(t){return this.spaces[t].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(t=this.workingColorSpace){return this.spaces[t].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(e,s){return d("ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),t.workingToColorSpace(e,s)},toWorkingColorSpace:function(e,s){return d("ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),t.colorSpaceToWorking(e,s)}},e=[.64,.33,.3,.6,.15,.06],s=[.2126,.7152,.0722],i=[.3127,.329];return t.define({[n]:{primaries:e,whitePoint:i,transfer:a,toXYZ:T,fromXYZ:B,luminanceCoefficients:s,workingColorSpaceConfig:{unpackColorSpace:r},outputColorSpaceConfig:{drawingBufferColorSpace:r}},[r]:{primaries:e,whitePoint:i,transfer:o,toXYZ:T,fromXYZ:B,luminanceCoefficients:s,outputColorSpaceConfig:{drawingBufferColorSpace:r}}}),t}const P=k();function C(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function V(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let F;class I{static getDataURL(t,e="image/png"){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let s;if(t instanceof HTMLCanvasElement)s=t;else{void 0===F&&(F=h("canvas")),F.width=t.width,F.height=t.height;const e=F.getContext("2d");t instanceof ImageData?e.putImageData(t,0,0):e.drawImage(t,0,0,t.width,t.height),s=F}return s.toDataURL(e)}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=h("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const i=s.getImageData(0,0,t.width,t.height),r=i.data;for(let t=0;t<r.length;t++)r[t]=255*C(r[t]/255);return s.putImageData(i,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*C(e[t]/255)):e[t]=C(e[t]);return{data:e,width:t.width,height:t.height}}return c("ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let E=0;class U{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:E++}),this.uuid=y(),this.data=t,this.dataReady=!0,this.version=0}getSize(t){const e=this.data;return"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement?t.set(e.videoWidth,e.videoHeight,0):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?t.set(e.displayHeight,e.displayWidth,0):null!==e?t.set(e.width,e.height,e.depth||0):t.set(0,0,0),t}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const s={uuid:this.uuid,url:""},i=this.data;if(null!==i){let t;if(Array.isArray(i)){t=[];for(let e=0,s=i.length;e<s;e++)i[e].isDataTexture?t.push(N(i[e].image)):t.push(N(i[e]))}else t=N(i);s.url=t}return e||(t.images[this.uuid]=s),s}}function N(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?I.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(c("Texture: Unable to serialize Texture."),{})}let O=0;const q=new M;class R extends p{constructor(t=R.DEFAULT_IMAGE,e=R.DEFAULT_MAPPING,s=1001,i=1001,r=1006,n=1008,a=1023,o=1009,h=R.DEFAULT_ANISOTROPY,l=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:O++}),this.uuid=y(),this.name="",this.source=new U(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=i,this.magFilter=r,this.minFilter=n,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new w(0,0),this.repeat=new w(1,1),this.center=new w(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new A,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=l,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(t&&t.depth&&t.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(q).x}get height(){return this.source.getSize(q).y}get depth(){return this.source.getSize(q).z}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.renderTarget=t.renderTarget,this.isRenderTargetTexture=t.isRenderTargetTexture,this.isArrayTexture=t.isArrayTexture,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}setValues(t){for(const e in t){const s=t[e];if(void 0===s){c(`Texture.setValues(): parameter '${e}' has value of undefined.`);continue}const i=this[e];void 0!==i?i&&s&&i.isVector2&&s.isVector2||i&&s&&i.isVector3&&s.isVector3||i&&s&&i.isMatrix3&&s.isMatrix3?i.copy(s):this[e]=s:c(`Texture.setValues(): property '${e}' does not exist.`)}}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const s={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(300!==this.mapping)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case 1e3:t.x=t.x-Math.floor(t.x);break;case 1001:t.x=t.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case 1e3:t.y=t.y-Math.floor(t.y);break;case 1001:t.y=t.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}R.DEFAULT_IMAGE=null,R.DEFAULT_MAPPING=300,R.DEFAULT_ANISOTROPY=1;class W{constructor(t=0,e=0,s=0,i=1){W.prototype.isVector4=!0,this.x=t,this.y=e,this.z=s,this.w=i}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=this.w,n=t.elements;return this.x=n[0]*e+n[4]*s+n[8]*i+n[12]*r,this.y=n[1]*e+n[5]*s+n[9]*i+n[13]*r,this.z=n[2]*e+n[6]*s+n[10]*i+n[14]*r,this.w=n[3]*e+n[7]*s+n[11]*i+n[15]*r,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,s,i,r;const n=.01,a=.1,o=t.elements,h=o[0],l=o[4],c=o[8],u=o[1],d=o[5],p=o[9],m=o[2],y=o[6],f=o[10];if(Math.abs(l-u)<n&&Math.abs(c-m)<n&&Math.abs(p-y)<n){if(Math.abs(l+u)<a&&Math.abs(c+m)<a&&Math.abs(p+y)<a&&Math.abs(h+d+f-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,o=(d+1)/2,x=(f+1)/2,g=(l+u)/4,b=(c+m)/4,w=(p+y)/4;return t>o&&t>x?t<n?(s=0,i=.707106781,r=.707106781):(s=Math.sqrt(t),i=g/s,r=b/s):o>x?o<n?(s=.707106781,i=0,r=.707106781):(i=Math.sqrt(o),s=g/i,r=w/i):x<n?(s=.707106781,i=.707106781,r=0):(r=Math.sqrt(x),s=b/r,i=w/r),this.set(s,i,r,e),this}let x=Math.sqrt((y-p)*(y-p)+(c-m)*(c-m)+(u-l)*(u-l));return Math.abs(x)<.001&&(x=1),this.x=(y-p)/x,this.y=(c-m)/x,this.z=(u-l)/x,this.w=Math.acos((h+d+f-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=f(this.x,t.x,e.x),this.y=f(this.y,t.y,e.y),this.z=f(this.z,t.z,e.z),this.w=f(this.w,t.w,e.w),this}clampScalar(t,e){return this.x=f(this.x,t,e),this.y=f(this.y,t,e),this.z=f(this.z,t,e),this.w=f(this.w,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(f(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this.w=t.w+(e.w-t.w)*s,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class D{constructor(t=new M(1/0,1/0,1/0),e=new M(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(j.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(j.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=j.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(void 0!==s){const i=s.getAttribute("position");if(!0===e&&void 0!==i&&!0!==t.isInstancedMesh)for(let e=0,s=i.count;e<s;e++)!0===t.isMesh?t.getVertexPosition(e,j):j.fromBufferAttribute(i,e),j.applyMatrix4(t.matrixWorld),this.expandByPoint(j);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),H.copy(t.boundingBox)):(null===s.boundingBox&&s.computeBoundingBox(),H.copy(s.boundingBox)),H.applyMatrix4(t.matrixWorld),this.union(H)}const i=t.children;for(let t=0,s=i.length;t<s;t++)this.expandByObject(i[t],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,j),j.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Q),K.subVectors(this.max,Q),Y.subVectors(t.a,Q),X.subVectors(t.b,Q),G.subVectors(t.c,Q),Z.subVectors(X,Y),J.subVectors(G,X),$.subVectors(Y,G);let e=[0,-Z.z,Z.y,0,-J.z,J.y,0,-$.z,$.y,Z.z,0,-Z.x,J.z,0,-J.x,$.z,0,-$.x,-Z.y,Z.x,0,-J.y,J.x,0,-$.y,$.x,0];return!!st(e,Y,X,G,K)&&(e=[1,0,0,0,1,0,0,0,1],!!st(e,Y,X,G,K)&&(tt.crossVectors(Z,J),e=[tt.x,tt.y,tt.z],st(e,Y,X,G,K)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,j).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(j).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(L[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),L[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),L[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),L[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),L[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),L[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),L[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),L[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(L)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(t){return this.min.fromArray(t.min),this.max.fromArray(t.max),this}}const L=[new M,new M,new M,new M,new M,new M,new M,new M],j=new M,H=new D,Y=new M,X=new M,G=new M,Z=new M,J=new M,$=new M,Q=new M,K=new M,tt=new M,et=new M;function st(t,e,s,i,r){for(let n=0,a=t.length-3;n<=a;n+=3){et.fromArray(t,n);const a=r.x*Math.abs(et.x)+r.y*Math.abs(et.y)+r.z*Math.abs(et.z),o=e.dot(et),h=s.dot(et),l=i.dot(et);if(Math.max(-Math.max(o,h,l),Math.min(o,h,l))>a)return!1}return!0}const it=new D,rt=new M,nt=new M;class at{constructor(t=new M,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const s=this.center;void 0!==e?s.copy(e):it.setFromPoints(t).getCenter(s);let i=0;for(let e=0,r=t.length;e<r;e++)i=Math.max(i,s.distanceToSquared(t[e]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const s=this.center.distanceToSquared(t);return e.copy(t),s>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;rt.subVectors(t,this.center);const e=rt.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),s=.5*(t-this.radius);this.center.addScaledVector(rt,s/t),this.radius+=s}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(nt.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(rt.copy(t.center).add(nt)),this.expandByPoint(rt.copy(t.center).sub(nt))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(t){return this.radius=t.radius,this.center.fromArray(t.center),this}}class ot{constructor(t,e,s,i,r,n,a,o,h,l,c,u,d,p,m,y){ot.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,s,i,r,n,a,o,h,l,c,u,d,p,m,y)}set(t,e,s,i,r,n,a,o,h,l,c,u,d,p,m,y){const f=this.elements;return f[0]=t,f[4]=e,f[8]=s,f[12]=i,f[1]=r,f[5]=n,f[9]=a,f[13]=o,f[2]=h,f[6]=l,f[10]=c,f[14]=u,f[3]=d,f[7]=p,f[11]=m,f[15]=y,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new ot).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return 0===this.determinant()?(t.set(1,0,0),e.set(0,1,0),s.set(0,0,1),this):(t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this)}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){if(0===t.determinant())return this.identity();const e=this.elements,s=t.elements,i=1/ht.setFromMatrixColumn(t,0).length(),r=1/ht.setFromMatrixColumn(t,1).length(),n=1/ht.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*n,e[9]=s[9]*n,e[10]=s[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,i=t.y,r=t.z,n=Math.cos(s),a=Math.sin(s),o=Math.cos(i),h=Math.sin(i),l=Math.cos(r),c=Math.sin(r);if("XYZ"===t.order){const t=n*l,s=n*c,i=a*l,r=a*c;e[0]=o*l,e[4]=-o*c,e[8]=h,e[1]=s+i*h,e[5]=t-r*h,e[9]=-a*o,e[2]=r-t*h,e[6]=i+s*h,e[10]=n*o}else if("YXZ"===t.order){const t=o*l,s=o*c,i=h*l,r=h*c;e[0]=t+r*a,e[4]=i*a-s,e[8]=n*h,e[1]=n*c,e[5]=n*l,e[9]=-a,e[2]=s*a-i,e[6]=r+t*a,e[10]=n*o}else if("ZXY"===t.order){const t=o*l,s=o*c,i=h*l,r=h*c;e[0]=t-r*a,e[4]=-n*c,e[8]=i+s*a,e[1]=s+i*a,e[5]=n*l,e[9]=r-t*a,e[2]=-n*h,e[6]=a,e[10]=n*o}else if("ZYX"===t.order){const t=n*l,s=n*c,i=a*l,r=a*c;e[0]=o*l,e[4]=i*h-s,e[8]=t*h+r,e[1]=o*c,e[5]=r*h+t,e[9]=s*h-i,e[2]=-h,e[6]=a*o,e[10]=n*o}else if("YZX"===t.order){const t=n*o,s=n*h,i=a*o,r=a*h;e[0]=o*l,e[4]=r-t*c,e[8]=i*c+s,e[1]=c,e[5]=n*l,e[9]=-a*l,e[2]=-h*l,e[6]=s*c+i,e[10]=t-r*c}else if("XZY"===t.order){const t=n*o,s=n*h,i=a*o,r=a*h;e[0]=o*l,e[4]=-c,e[8]=h*l,e[1]=t*c+r,e[5]=n*l,e[9]=s*c-i,e[2]=i*c-s,e[6]=a*l,e[10]=r*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(ct,t,ut)}lookAt(t,e,s){const i=this.elements;return mt.subVectors(t,e),0===mt.lengthSq()&&(mt.z=1),mt.normalize(),dt.crossVectors(s,mt),0===dt.lengthSq()&&(1===Math.abs(s.z)?mt.x+=1e-4:mt.z+=1e-4,mt.normalize(),dt.crossVectors(s,mt)),dt.normalize(),pt.crossVectors(mt,dt),i[0]=dt.x,i[4]=pt.x,i[8]=mt.x,i[1]=dt.y,i[5]=pt.y,i[9]=mt.y,i[2]=dt.z,i[6]=pt.z,i[10]=mt.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],a=s[4],o=s[8],h=s[12],l=s[1],c=s[5],u=s[9],d=s[13],p=s[2],m=s[6],y=s[10],f=s[14],x=s[3],g=s[7],b=s[11],w=s[15],_=i[0],M=i[4],z=i[8],S=i[12],A=i[1],v=i[5],T=i[9],B=i[13],k=i[2],P=i[6],C=i[10],V=i[14],F=i[3],I=i[7],E=i[11],U=i[15];return r[0]=n*_+a*A+o*k+h*F,r[4]=n*M+a*v+o*P+h*I,r[8]=n*z+a*T+o*C+h*E,r[12]=n*S+a*B+o*V+h*U,r[1]=l*_+c*A+u*k+d*F,r[5]=l*M+c*v+u*P+d*I,r[9]=l*z+c*T+u*C+d*E,r[13]=l*S+c*B+u*V+d*U,r[2]=p*_+m*A+y*k+f*F,r[6]=p*M+m*v+y*P+f*I,r[10]=p*z+m*T+y*C+f*E,r[14]=p*S+m*B+y*V+f*U,r[3]=x*_+g*A+b*k+w*F,r[7]=x*M+g*v+b*P+w*I,r[11]=x*z+g*T+b*C+w*E,r[15]=x*S+g*B+b*V+w*U,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],r=t[12],n=t[1],a=t[5],o=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14],p=t[3],m=t[7],y=t[11],f=t[15],x=o*d-h*u,g=a*d-h*c,b=a*u-o*c,w=n*d-h*l,_=n*u-o*l,M=n*c-a*l;return e*(m*x-y*g+f*b)-s*(p*x-y*w+f*_)+i*(p*g-m*w+f*M)-r*(p*b-m*_+y*M)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11],p=t[12],m=t[13],y=t[14],f=t[15],x=c*y*h-m*u*h+m*o*d-a*y*d-c*o*f+a*u*f,g=p*u*h-l*y*h-p*o*d+n*y*d+l*o*f-n*u*f,b=l*m*h-p*c*h+p*a*d-n*m*d-l*a*f+n*c*f,w=p*c*o-l*m*o-p*a*u+n*m*u+l*a*y-n*c*y,_=e*x+s*g+i*b+r*w;if(0===_)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const M=1/_;return t[0]=x*M,t[1]=(m*u*r-c*y*r-m*i*d+s*y*d+c*i*f-s*u*f)*M,t[2]=(a*y*r-m*o*r+m*i*h-s*y*h-a*i*f+s*o*f)*M,t[3]=(c*o*r-a*u*r-c*i*h+s*u*h+a*i*d-s*o*d)*M,t[4]=g*M,t[5]=(l*y*r-p*u*r+p*i*d-e*y*d-l*i*f+e*u*f)*M,t[6]=(p*o*r-n*y*r-p*i*h+e*y*h+n*i*f-e*o*f)*M,t[7]=(n*u*r-l*o*r+l*i*h-e*u*h-n*i*d+e*o*d)*M,t[8]=b*M,t[9]=(p*c*r-l*m*r-p*s*d+e*m*d+l*s*f-e*c*f)*M,t[10]=(n*m*r-p*a*r+p*s*h-e*m*h-n*s*f+e*a*f)*M,t[11]=(l*a*r-n*c*r-l*s*h+e*c*h+n*s*d-e*a*d)*M,t[12]=w*M,t[13]=(l*m*i-p*c*i+p*s*u-e*m*u-l*s*y+e*c*y)*M,t[14]=(p*a*i-n*m*i-p*s*o+e*m*o+n*s*y-e*a*y)*M,t[15]=(n*c*i-l*a*i+l*s*o-e*c*o-n*s*u+e*a*u)*M,this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),r=1-s,n=t.x,a=t.y,o=t.z,h=r*n,l=r*a;return this.set(h*n+s,h*a-i*o,h*o+i*a,0,h*a+i*o,l*a+s,l*o-i*n,0,h*o-i*a,l*o+i*n,r*o*o+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,i,r,n){return this.set(1,s,r,0,t,1,n,0,e,i,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,r=e._x,n=e._y,a=e._z,o=e._w,h=r+r,l=n+n,c=a+a,u=r*h,d=r*l,p=r*c,m=n*l,y=n*c,f=a*c,x=o*h,g=o*l,b=o*c,w=s.x,_=s.y,M=s.z;return i[0]=(1-(m+f))*w,i[1]=(d+b)*w,i[2]=(p-g)*w,i[3]=0,i[4]=(d-b)*_,i[5]=(1-(u+f))*_,i[6]=(y+x)*_,i[7]=0,i[8]=(p+g)*M,i[9]=(y-x)*M,i[10]=(1-(u+m))*M,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;if(t.x=i[12],t.y=i[13],t.z=i[14],0===this.determinant())return s.set(1,1,1),e.identity(),this;let r=ht.set(i[0],i[1],i[2]).length();const n=ht.set(i[4],i[5],i[6]).length(),a=ht.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),lt.copy(this);const o=1/r,h=1/n,l=1/a;return lt.elements[0]*=o,lt.elements[1]*=o,lt.elements[2]*=o,lt.elements[4]*=h,lt.elements[5]*=h,lt.elements[6]*=h,lt.elements[8]*=l,lt.elements[9]*=l,lt.elements[10]*=l,e.setFromRotationMatrix(lt),s.x=r,s.y=n,s.z=a,this}makePerspective(t,e,s,i,r,n,a=2e3,o=!1){const h=this.elements,l=2*r/(e-t),c=2*r/(s-i),u=(e+t)/(e-t),d=(s+i)/(s-i);let p,m;if(o)p=r/(n-r),m=n*r/(n-r);else if(2e3===a)p=-(n+r)/(n-r),m=-2*n*r/(n-r);else{if(2001!==a)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);p=-n/(n-r),m=-n*r/(n-r)}return h[0]=l,h[4]=0,h[8]=u,h[12]=0,h[1]=0,h[5]=c,h[9]=d,h[13]=0,h[2]=0,h[6]=0,h[10]=p,h[14]=m,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,i,r,n,a=2e3,o=!1){const h=this.elements,l=2/(e-t),c=2/(s-i),u=-(e+t)/(e-t),d=-(s+i)/(s-i);let p,m;if(o)p=1/(n-r),m=n/(n-r);else if(2e3===a)p=-2/(n-r),m=-(n+r)/(n-r);else{if(2001!==a)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=-1/(n-r),m=-r/(n-r)}return h[0]=l,h[4]=0,h[8]=0,h[12]=u,h[1]=0,h[5]=c,h[9]=0,h[13]=d,h[2]=0,h[6]=0,h[10]=p,h[14]=m,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const ht=new M,lt=new ot,ct=new M(0,0,0),ut=new M(1,1,1),dt=new M,pt=new M,mt=new M,yt=new ot,ft=new _;class xt{constructor(t=0,e=0,s=0,i=xt.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,i=this._order){return this._x=t,this._y=e,this._z=s,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const i=t.elements,r=i[0],n=i[4],a=i[8],o=i[1],h=i[5],l=i[9],u=i[2],d=i[6],p=i[10];switch(e){case"XYZ":this._y=Math.asin(f(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,p),this._z=Math.atan2(-n,r)):(this._x=Math.atan2(d,h),this._z=0);break;case"YXZ":this._x=Math.asin(-f(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(a,p),this._z=Math.atan2(o,h)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(f(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-n,h)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-f(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(d,p),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-n,h));break;case"YZX":this._z=Math.asin(f(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(a,p));break;case"XZY":this._z=Math.asin(-f(n,-1,1)),Math.abs(n)<.9999999?(this._x=Math.atan2(d,h),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-l,p),this._y=0);break;default:c("Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!0===s&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return yt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(yt,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return ft.setFromEuler(this),this.setFromQuaternion(ft,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}xt.DEFAULT_ORDER="XYZ";class gt{constructor(){this.mask=1}set(t){this.mask=1<<t>>>0}enable(t){this.mask|=1<<t}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t}disable(t){this.mask&=~(1<<t)}disableAll(){this.mask=0}test(t){return 0!==(this.mask&t.mask)}isEnabled(t){return!!(this.mask&1<<t)}}let bt=0;const wt=new M,_t=new _,Mt=new ot,zt=new M,St=new M,At=new M,vt=new _,Tt=new M(1,0,0),Bt=new M(0,1,0),kt=new M(0,0,1),Pt={type:"added"},Ct={type:"removed"},Vt={type:"childadded",child:null},Ft={type:"childremoved",child:null};class It extends p{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:bt++}),this.uuid=y(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=It.DEFAULT_UP.clone();const t=new M,e=new xt,s=new _,i=new M(1,1,1);e._onChange(function(){s.setFromEuler(e,!1)}),s._onChange(function(){e.setFromQuaternion(s,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new ot},normalMatrix:{value:new A}}),this.matrix=new ot,this.matrixWorld=new ot,this.matrixAutoUpdate=It.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=It.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new gt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return _t.setFromAxisAngle(t,e),this.quaternion.multiply(_t),this}rotateOnWorldAxis(t,e){return _t.setFromAxisAngle(t,e),this.quaternion.premultiply(_t),this}rotateX(t){return this.rotateOnAxis(Tt,t)}rotateY(t){return this.rotateOnAxis(Bt,t)}rotateZ(t){return this.rotateOnAxis(kt,t)}translateOnAxis(t,e){return wt.copy(t).applyQuaternion(this.quaternion),this.position.add(wt.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(Tt,t)}translateY(t){return this.translateOnAxis(Bt,t)}translateZ(t){return this.translateOnAxis(kt,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(Mt.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?zt.copy(t):zt.set(t,e,s);const i=this.parent;this.updateWorldMatrix(!0,!1),St.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Mt.lookAt(St,zt,this.up):Mt.lookAt(zt,St,this.up),this.quaternion.setFromRotationMatrix(Mt),i&&(Mt.extractRotation(i.matrixWorld),_t.setFromRotationMatrix(Mt),this.quaternion.premultiply(_t.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(u("Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(Pt),Vt.child=t,this.dispatchEvent(Vt),Vt.child=null):u("Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Ct),Ft.child=t,this.dispatchEvent(Ft),Ft.child=null),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),Mt.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),Mt.multiply(t.parent.matrixWorld)),t.applyMatrix4(Mt),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(Pt),Vt.child=t,this.dispatchEvent(Vt),Vt.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,i=this.children.length;s<i;s++){const i=this.children[s].getObjectByProperty(t,e);if(void 0!==i)return i}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(St,t,At),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(St,vt,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].updateMatrixWorld(t)}updateWorldMatrix(t,e){const s=this.parent;if(!0===t&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].updateWorldMatrix(!1,!0)}}toJSON(t){const e=void 0===t||"string"==typeof t,s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};function r(e,s){return void 0===e[s.uuid]&&(e[s.uuid]=s.toJSON(t)),s.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map(t=>({...t,boundingBox:t.boundingBox?t.boundingBox.toJSON():void 0,boundingSphere:t.boundingSphere?t.boundingSphere.toJSON():void 0})),i.instanceInfo=this._instanceInfo.map(t=>({...t})),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(t),i.indirectTexture=this._indirectTexture.toJSON(t),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(t)),null!==this.boundingSphere&&(i.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(i.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const s=e.shapes;if(Array.isArray(s))for(let e=0,i=s.length;e<i;e++){const i=s[e];r(t.shapes,i)}else r(t.shapes,s)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let s=0,i=this.material.length;s<i;s++)e.push(r(t.materials,this.material[s]));i.material=e}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let e=0;e<this.children.length;e++)i.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let e=0;e<this.animations.length;e++){const s=this.animations[e];i.animations.push(r(t.animations,s))}}if(e){const e=n(t.geometries),i=n(t.materials),r=n(t.textures),a=n(t.images),o=n(t.shapes),h=n(t.skeletons),l=n(t.animations),c=n(t.nodes);e.length>0&&(s.geometries=e),i.length>0&&(s.materials=i),r.length>0&&(s.textures=r),a.length>0&&(s.images=a),o.length>0&&(s.shapes=o),h.length>0&&(s.skeletons=h),l.length>0&&(s.animations=l),c.length>0&&(s.nodes=c)}return s.object=i,s;function n(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const s=t.children[e];this.add(s.clone())}return this}}It.DEFAULT_UP=new M(0,1,0),It.DEFAULT_MATRIX_AUTO_UPDATE=!0,It.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Et=new M,Ut=new M,Nt=new M,Ot=new M,qt=new M,Rt=new M,Wt=new M,Dt=new M,Lt=new M,jt=new M,Ht=new W,Yt=new W,Xt=new W;class Gt{constructor(t=new M,e=new M,s=new M){this.a=t,this.b=e,this.c=s}static getNormal(t,e,s,i){i.subVectors(s,e),Et.subVectors(t,e),i.cross(Et);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(t,e,s,i,r){Et.subVectors(i,e),Ut.subVectors(s,e),Nt.subVectors(t,e);const n=Et.dot(Et),a=Et.dot(Ut),o=Et.dot(Nt),h=Ut.dot(Ut),l=Ut.dot(Nt),c=n*h-a*a;if(0===c)return r.set(0,0,0),null;const u=1/c,d=(h*o-a*l)*u,p=(n*l-a*o)*u;return r.set(1-d-p,p,d)}static containsPoint(t,e,s,i){return null!==this.getBarycoord(t,e,s,i,Ot)&&Ot.x>=0&&Ot.y>=0&&Ot.x+Ot.y<=1}static getInterpolation(t,e,s,i,r,n,a,o){return null===this.getBarycoord(t,e,s,i,Ot)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(r,Ot.x),o.addScaledVector(n,Ot.y),o.addScaledVector(a,Ot.z),o)}static getInterpolatedAttribute(t,e,s,i,r,n){return Ht.setScalar(0),Yt.setScalar(0),Xt.setScalar(0),Ht.fromBufferAttribute(t,e),Yt.fromBufferAttribute(t,s),Xt.fromBufferAttribute(t,i),n.setScalar(0),n.addScaledVector(Ht,r.x),n.addScaledVector(Yt,r.y),n.addScaledVector(Xt,r.z),n}static isFrontFacing(t,e,s,i){return Et.subVectors(s,e),Ut.subVectors(t,e),Et.cross(Ut).dot(i)<0}set(t,e,s){return this.a.copy(t),this.b.copy(e),this.c.copy(s),this}setFromPointsAndIndices(t,e,s,i){return this.a.copy(t[e]),this.b.copy(t[s]),this.c.copy(t[i]),this}setFromAttributeAndIndices(t,e,s,i){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,s),this.c.fromBufferAttribute(t,i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Et.subVectors(this.c,this.b),Ut.subVectors(this.a,this.b),.5*Et.cross(Ut).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Gt.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Gt.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,s,i,r){return Gt.getInterpolation(t,this.a,this.b,this.c,e,s,i,r)}containsPoint(t){return Gt.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Gt.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const s=this.a,i=this.b,r=this.c;let n,a;qt.subVectors(i,s),Rt.subVectors(r,s),Dt.subVectors(t,s);const o=qt.dot(Dt),h=Rt.dot(Dt);if(o<=0&&h<=0)return e.copy(s);Lt.subVectors(t,i);const l=qt.dot(Lt),c=Rt.dot(Lt);if(l>=0&&c<=l)return e.copy(i);const u=o*c-l*h;if(u<=0&&o>=0&&l<=0)return n=o/(o-l),e.copy(s).addScaledVector(qt,n);jt.subVectors(t,r);const d=qt.dot(jt),p=Rt.dot(jt);if(p>=0&&d<=p)return e.copy(r);const m=d*h-o*p;if(m<=0&&h>=0&&p<=0)return a=h/(h-p),e.copy(s).addScaledVector(Rt,a);const y=l*p-d*c;if(y<=0&&c-l>=0&&d-p>=0)return Wt.subVectors(r,i),a=(c-l)/(c-l+(d-p)),e.copy(i).addScaledVector(Wt,a);const f=1/(y+m+u);return n=m*f,a=u*f,e.copy(s).addScaledVector(qt,n).addScaledVector(Rt,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const Zt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Jt={h:0,s:0,l:0},$t={h:0,s:0,l:0};function Qt(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+6*(e-t)*(2/3-s):t}class Kt{constructor(t,e,s){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,s)}set(t,e,s){if(void 0===e&&void 0===s){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,s);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=r){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,P.colorSpaceToWorking(this,e),this}setRGB(t,e,s,i=P.workingColorSpace){return this.r=t,this.g=e,this.b=s,P.colorSpaceToWorking(this,i),this}setHSL(t,e,s,i=P.workingColorSpace){if(t=(t%(r=1)+r)%r,e=f(e,0,1),s=f(s,0,1),0===e)this.r=this.g=this.b=s;else{const i=s<=.5?s*(1+e):s+e-s*e,r=2*s-i;this.r=Qt(r,i,t+1/3),this.g=Qt(r,i,t),this.b=Qt(r,i,t-1/3)}var r;return P.colorSpaceToWorking(this,i),this}setStyle(t,e=r){function s(e){void 0!==e&&parseFloat(e)<1&&c("Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(t)){let r;const n=i[1],a=i[2];switch(n){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,e);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,e);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,e);break;default:c("Color: Unknown color model "+t)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const s=i[1],r=s.length;if(3===r)return this.setRGB(parseInt(s.charAt(0),16)/15,parseInt(s.charAt(1),16)/15,parseInt(s.charAt(2),16)/15,e);if(6===r)return this.setHex(parseInt(s,16),e);c("Color: Invalid hex color "+t)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=r){const s=Zt[t.toLowerCase()];return void 0!==s?this.setHex(s,e):c("Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=C(t.r),this.g=C(t.g),this.b=C(t.b),this}copyLinearToSRGB(t){return this.r=V(t.r),this.g=V(t.g),this.b=V(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=r){return P.workingToColorSpace(te.copy(this),t),65536*Math.round(f(255*te.r,0,255))+256*Math.round(f(255*te.g,0,255))+Math.round(f(255*te.b,0,255))}getHexString(t=r){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=P.workingColorSpace){P.workingToColorSpace(te.copy(this),e);const s=te.r,i=te.g,r=te.b,n=Math.max(s,i,r),a=Math.min(s,i,r);let o,h;const l=(a+n)/2;if(a===n)o=0,h=0;else{const t=n-a;switch(h=l<=.5?t/(n+a):t/(2-n-a),n){case s:o=(i-r)/t+(i<r?6:0);break;case i:o=(r-s)/t+2;break;case r:o=(s-i)/t+4}o/=6}return t.h=o,t.s=h,t.l=l,t}getRGB(t,e=P.workingColorSpace){return P.workingToColorSpace(te.copy(this),e),t.r=te.r,t.g=te.g,t.b=te.b,t}getStyle(t=r){P.workingToColorSpace(te.copy(this),t);const e=te.r,s=te.g,i=te.b;return t!==r?`color(${t} ${e.toFixed(3)} ${s.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*s)},${Math.round(255*i)})`}offsetHSL(t,e,s){return this.getHSL(Jt),this.setHSL(Jt.h+t,Jt.s+e,Jt.l+s)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,s){return this.r=t.r+(e.r-t.r)*s,this.g=t.g+(e.g-t.g)*s,this.b=t.b+(e.b-t.b)*s,this}lerpHSL(t,e){this.getHSL(Jt),t.getHSL($t);const s=x(Jt.h,$t.h,e),i=x(Jt.s,$t.s,e),r=x(Jt.l,$t.l,e);return this.setHSL(s,i,r),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,s=this.g,i=this.b,r=t.elements;return this.r=r[0]*e+r[3]*s+r[6]*i,this.g=r[1]*e+r[4]*s+r[7]*i,this.b=r[2]*e+r[5]*s+r[8]*i,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const te=new Kt;Kt.NAMES=Zt;const ee=new M,se=new w;let ie=0;class re{constructor(t,e,s=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:ie++}),this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=s,this.usage=35044,this.updateRanges=[],this.gpuType=1015,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,s){t*=this.itemSize,s*=e.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[t+i]=e.array[s+i];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,s=this.count;e<s;e++)se.fromBufferAttribute(this,e),se.applyMatrix3(t),this.setXY(e,se.x,se.y);else if(3===this.itemSize)for(let e=0,s=this.count;e<s;e++)ee.fromBufferAttribute(this,e),ee.applyMatrix3(t),this.setXYZ(e,ee.x,ee.y,ee.z);return this}applyMatrix4(t){for(let e=0,s=this.count;e<s;e++)ee.fromBufferAttribute(this,e),ee.applyMatrix4(t),this.setXYZ(e,ee.x,ee.y,ee.z);return this}applyNormalMatrix(t){for(let e=0,s=this.count;e<s;e++)ee.fromBufferAttribute(this,e),ee.applyNormalMatrix(t),this.setXYZ(e,ee.x,ee.y,ee.z);return this}transformDirection(t){for(let e=0,s=this.count;e<s;e++)ee.fromBufferAttribute(this,e),ee.transformDirection(t),this.setXYZ(e,ee.x,ee.y,ee.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let s=this.array[t*this.itemSize+e];return this.normalized&&(s=g(s,this.array)),s}setComponent(t,e,s){return this.normalized&&(s=b(s,this.array)),this.array[t*this.itemSize+e]=s,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=g(e,this.array)),e}setX(t,e){return this.normalized&&(e=b(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=g(e,this.array)),e}setY(t,e){return this.normalized&&(e=b(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=g(e,this.array)),e}setZ(t,e){return this.normalized&&(e=b(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=g(e,this.array)),e}setW(t,e){return this.normalized&&(e=b(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,s){return t*=this.itemSize,this.normalized&&(e=b(e,this.array),s=b(s,this.array)),this.array[t+0]=e,this.array[t+1]=s,this}setXYZ(t,e,s,i){return t*=this.itemSize,this.normalized&&(e=b(e,this.array),s=b(s,this.array),i=b(i,this.array)),this.array[t+0]=e,this.array[t+1]=s,this.array[t+2]=i,this}setXYZW(t,e,s,i,r){return t*=this.itemSize,this.normalized&&(e=b(e,this.array),s=b(s,this.array),i=b(i,this.array),r=b(r,this.array)),this.array[t+0]=e,this.array[t+1]=s,this.array[t+2]=i,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),35044!==this.usage&&(t.usage=this.usage),t}}const ne=new M,ae=new M,oe=new A;class he{constructor(t=new M(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,s,i){return this.normal.set(t,e,s),this.constant=i,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,s){const i=ne.subVectors(s,e).cross(ae.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const s=t.delta(ne),i=this.normal.dot(s);if(0===i)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const r=-(t.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:e.copy(t.start).addScaledVector(s,r)}intersectsLine(t){const e=this.distanceToPoint(t.start),s=this.distanceToPoint(t.end);return e<0&&s>0||s<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const s=e||oe.getNormalMatrix(t),i=this.coplanarPoint(ne).applyMatrix4(t),r=this.normal.applyMatrix3(s).normalize();return this.constant=-i.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}function le(t,e){return t&&t.constructor!==e?"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t):t}class ce{constructor(t,e,s,i){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new e.constructor(s),this.sampleValues=e,this.valueSize=s,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let s=this._cachedIndex,i=e[s],r=e[s-1];t:{e:{let n;s:{i:if(!(t<i)){for(let n=s+2;;){if(void 0===i){if(t<r)break i;return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}if(s===n)break;if(r=i,i=e[++s],t<i)break e}n=e.length;break s}if(!(t>=r)){const a=e[1];t<a&&(s=2,r=a);for(let n=s-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(s===n)break;if(i=r,r=e[--s-1],t>=r)break e}n=s,s=0;break s}break t}for(;s<n;){const i=s+n>>>1;t<e[i]?n=i:s=i+1}if(i=e[s],r=e[s-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===i)return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}this._cachedIndex=s,this.intervalChanged_(s,r,i)}return this.interpolate_(s,r,t,i)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=t*i;for(let t=0;t!==i;++t)e[t]=s[r+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class ue extends ce{constructor(t,e,s,i){super(t,e,s,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(t,e,s){const i=this.parameterPositions;let r=t-2,n=t+1,a=i[r],o=i[n];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:r=t,a=2*e-s;break;case 2402:r=i.length-2,a=e+i[r]-i[r+1];break;default:r=t,a=s}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:n=t,o=2*s-e;break;case 2402:n=1,o=s+i[1]-i[0];break;default:n=t-1,o=e}const h=.5*(s-e),l=this.valueSize;this._weightPrev=h/(e-a),this._weightNext=h/(o-s),this._offsetPrev=r*l,this._offsetNext=n*l}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=this._offsetPrev,c=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(s-e)/(i-e),m=p*p,y=m*p,f=-u*y+2*u*m-u*p,x=(1+u)*y+(-1.5-2*u)*m+(-.5+u)*p+1,g=(-1-d)*y+(1.5+d)*m+.5*p,b=d*y-d*m;for(let t=0;t!==a;++t)r[t]=f*n[l+t]+x*n[h+t]+g*n[o+t]+b*n[c+t];return r}}class de extends ce{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=(s-e)/(i-e),c=1-l;for(let t=0;t!==a;++t)r[t]=n[h+t]*c+n[o+t]*l;return r}}class pe extends ce{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t){return this.copySampleValue_(t-1)}}class me{constructor(t,e,s,i){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=le(e,this.TimeBufferType),this.values=le(s,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let s;if(e.toJSON!==this.toJSON)s=e.toJSON(t);else{s={name:t.name,times:le(t.times,Array),values:le(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(s.interpolation=e)}return s.type=t.ValueTypeName,s}InterpolantFactoryMethodDiscrete(t){return new pe(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new de(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new ue(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let r;switch(t){case e:r=this.InterpolantFactoryMethodDiscrete;break;case s:r=this.InterpolantFactoryMethodLinear;break;case i:r=this.InterpolantFactoryMethodSmooth}if(void 0===r){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return c("KeyframeTrack:",e),this}return this.createInterpolant=r,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return e;case this.InterpolantFactoryMethodLinear:return s;case this.InterpolantFactoryMethodSmooth:return i}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let s=0,i=e.length;s!==i;++s)e[s]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let s=0,i=e.length;s!==i;++s)e[s]*=t}return this}trim(t,e){const s=this.times,i=s.length;let r=0,n=i-1;for(;r!==i&&s[r]<t;)++r;for(;-1!==n&&s[n]>e;)--n;if(++n,0!==r||n!==i){r>=n&&(n=Math.max(n,1),r=n-1);const t=this.getValueSize();this.times=s.slice(r,n),this.values=this.values.slice(r*t,n*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!==0&&(u("KeyframeTrack: Invalid value size in track.",this),t=!1);const s=this.times,i=this.values,r=s.length;0===r&&(u("KeyframeTrack: Track is empty.",this),t=!1);let n=null;for(let e=0;e!==r;e++){const i=s[e];if("number"==typeof i&&isNaN(i)){u("KeyframeTrack: Time is not a valid number.",this,e,i),t=!1;break}if(null!==n&&n>i){u("KeyframeTrack: Out of order keys.",this,e,i,n),t=!1;break}n=i}if(void 0!==i&&(a=i,ArrayBuffer.isView(a)&&!(a instanceof DataView)))for(let e=0,s=i.length;e!==s;++e){const s=i[e];if(isNaN(s)){u("KeyframeTrack: Value is not a valid number.",this,e,s),t=!1;break}}var a;return t}optimize(){const t=this.times.slice(),e=this.values.slice(),s=this.getValueSize(),r=this.getInterpolation()===i,n=t.length-1;let a=1;for(let i=1;i<n;++i){let n=!1;const o=t[i];if(o!==t[i+1]&&(1!==i||o!==t[0]))if(r)n=!0;else{const t=i*s,r=t-s,a=t+s;for(let i=0;i!==s;++i){const s=e[t+i];if(s!==e[r+i]||s!==e[a+i]){n=!0;break}}}if(n){if(i!==a){t[a]=t[i];const r=i*s,n=a*s;for(let t=0;t!==s;++t)e[n+t]=e[r+t]}++a}}if(n>0){t[a]=t[n];for(let t=n*s,i=a*s,r=0;r!==s;++r)e[i+r]=e[t+r];++a}return a!==t.length?(this.times=t.slice(0,a),this.values=e.slice(0,a*s)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),s=new(0,this.constructor)(this.name,t,e);return s.createInterpolant=this.createInterpolant,s}}me.prototype.ValueTypeName="",me.prototype.TimeBufferType=Float32Array,me.prototype.ValueBufferType=Float32Array,me.prototype.DefaultInterpolation=s;class ye extends me{constructor(t,e,s){super(t,e,s)}}ye.prototype.ValueTypeName="bool",ye.prototype.ValueBufferType=Array,ye.prototype.DefaultInterpolation=e,ye.prototype.InterpolantFactoryMethodLinear=void 0,ye.prototype.InterpolantFactoryMethodSmooth=void 0;(class extends me{constructor(t,e,s,i){super(t,e,s,i)}}).prototype.ValueTypeName="color";(class extends me{constructor(t,e,s,i){super(t,e,s,i)}}).prototype.ValueTypeName="number";class fe extends ce{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=(s-e)/(i-e);let h=t*a;for(let t=h+a;h!==t;h+=4)_.slerpFlat(r,0,n,h-a,n,h,o);return r}}class xe extends me{constructor(t,e,s,i){super(t,e,s,i)}InterpolantFactoryMethodLinear(t){return new fe(this.times,this.values,this.getValueSize(),t)}}xe.prototype.ValueTypeName="quaternion",xe.prototype.InterpolantFactoryMethodSmooth=void 0;class ge extends me{constructor(t,e,s){super(t,e,s)}}ge.prototype.ValueTypeName="string",ge.prototype.ValueBufferType=Array,ge.prototype.DefaultInterpolation=e,ge.prototype.InterpolantFactoryMethodLinear=void 0,ge.prototype.InterpolantFactoryMethodSmooth=void 0;(class extends me{constructor(t,e,s,i){super(t,e,s,i)}}).prototype.ValueTypeName="vector";Error,new WeakMap,new WeakMap;const be="\\[\\]\\.:\\/",we=new RegExp("["+be+"]","g"),_e="[^"+be+"]",Me="[^"+be.replace("\\.","")+"]",ze=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",_e)+/(WCOD+)?/.source.replace("WCOD",Me)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",_e)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",_e)+"$"),Se=["material","materials","bones","map"];class Ae{constructor(t,e,s){this.path=e,this.parsedPath=s||Ae.parseTrackName(e),this.node=Ae.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(t,e,s){return t&&t.isAnimationObjectGroup?new Ae.Composite(t,e,s):new Ae(t,e,s)}static sanitizeNodeName(t){return t.replace(/\s/g,"_").replace(we,"")}static parseTrackName(t){const e=ze.exec(t);if(null===e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const s={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},i=s.nodeName&&s.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){const t=s.nodeName.substring(i+1);-1!==Se.indexOf(t)&&(s.nodeName=s.nodeName.substring(0,i),s.objectName=t)}if(null===s.propertyName||0===s.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return s}static findNode(t,e){if(void 0===e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const s=t.skeleton.getBoneByName(e);if(void 0!==s)return s}if(t.children){const s=function(t){for(let i=0;i<t.length;i++){const r=t[i];if(r.name===e||r.uuid===e)return r;const n=s(r.children);if(n)return n}return null},i=s(t.children);if(i)return i}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(t,e){t[e]=this.targetObject[this.propertyName]}_getValue_array(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)t[e++]=s[i]}_getValue_arrayElement(t,e){t[e]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(t,e){this.resolvedProperty.toArray(t,e)}_setValue_direct(t,e){this.targetObject[this.propertyName]=t[e]}_setValue_direct_setNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=t[e++]}_setValue_array_setNeedsUpdate(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=t[e++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(t,e){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(t,e){this.resolvedProperty[this.propertyIndex]=t[e]}_setValue_arrayElement_setNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(t,e){this.resolvedProperty.fromArray(t,e)}_setValue_fromArray_setNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(t,e){this.bind(),this.getValue(t,e)}_setValue_unbound(t,e){this.bind(),this.setValue(t,e)}bind(){let t=this.node;const e=this.parsedPath,s=e.objectName,i=e.propertyName;let r=e.propertyIndex;if(t||(t=Ae.findNode(this.rootNode,e.nodeName),this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return void c("PropertyBinding: No target node found for track: "+this.path+".");if(s){let i=e.objectIndex;switch(s){case"materials":if(!t.material)return void u("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void u("PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void u("PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===i){i=e;break}break;case"map":if("map"in t){t=t.map;break}if(!t.material)return void u("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.map)return void u("PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);t=t.material.map;break;default:if(void 0===t[s])return void u("PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[s]}if(void 0!==i){if(void 0===t[i])return void u("PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[i]}}const n=t[i];if(void 0===n)return void u("PropertyBinding: Trying to update property for track: "+e.nodeName+"."+i+" but it wasn't found.",t);let a=this.Versioning.None;this.targetObject=t,!0===t.isMaterial?a=this.Versioning.NeedsUpdate:!0===t.isObject3D&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===i){if(!t.geometry)return void u("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!t.geometry.morphAttributes)return void u("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==t.morphTargetDictionary[r]&&(r=t.morphTargetDictionary[r])}o=this.BindingType.ArrayElement,this.resolvedProperty=n,this.propertyIndex=r}else void 0!==n.fromArray&&void 0!==n.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=n):Array.isArray(n)?(o=this.BindingType.EntireArray,this.resolvedProperty=n):this.propertyName=i;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}Ae.Composite=class{constructor(t,e,s){const i=s||Ae.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,i)}getValue(t,e){this.bind();const s=this._targetGroup.nCachedObjects_,i=this._bindings[s];void 0!==i&&i.getValue(t,e)}setValue(t,e){const s=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=s.length;i!==r;++i)s[i].setValue(t,e)}bind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,s=t.length;e!==s;++e)t[e].bind()}unbind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,s=t.length;e!==s;++e)t[e].unbind()}},Ae.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Ae.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},Ae.prototype.GetterByBindingType=[Ae.prototype._getValue_direct,Ae.prototype._getValue_array,Ae.prototype._getValue_arrayElement,Ae.prototype._getValue_toArray],Ae.prototype.SetterByBindingTypeAndVersioning=[[Ae.prototype._setValue_direct,Ae.prototype._setValue_direct_setNeedsUpdate,Ae.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Ae.prototype._setValue_array,Ae.prototype._setValue_array_setNeedsUpdate,Ae.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Ae.prototype._setValue_arrayElement,Ae.prototype._setValue_arrayElement_setNeedsUpdate,Ae.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Ae.prototype._setValue_fromArray,Ae.prototype._setValue_fromArray_setNeedsUpdate,Ae.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1);const ve=new M,Te=new M,Be=new M,ke=new M,Pe=new M,Ce=new M,Ve=new M;class Fe{constructor(t=new M,e=new M){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){ve.subVectors(t,this.start),Te.subVectors(this.end,this.start);const s=Te.dot(Te);let i=Te.dot(ve)/s;return e&&(i=f(i,0,1)),i}closestPointToPoint(t,e,s){const i=this.closestPointToPointParameter(t,e);return this.delta(s).multiplyScalar(i).add(this.start)}distanceSqToLine3(t,e=Ce,s=Ve){const i=1e-8*1e-8;let r,n;const a=this.start,o=t.start,h=this.end,l=t.end;Be.subVectors(h,a),ke.subVectors(l,o),Pe.subVectors(a,o);const c=Be.dot(Be),u=ke.dot(ke),d=ke.dot(Pe);if(c<=i&&u<=i)return e.copy(a),s.copy(o),e.sub(s),e.dot(e);if(c<=i)r=0,n=d/u,n=f(n,0,1);else{const t=Be.dot(Pe);if(u<=i)n=0,r=f(-t/c,0,1);else{const e=Be.dot(ke),s=c*u-e*e;r=0!==s?f((e*d-t*u)/s,0,1):0,n=(e*r+d)/u,n<0?(n=0,r=f(-t/c,0,1)):n>1&&(n=1,r=f((e-t)/c,0,1))}}return e.copy(a).add(Be.multiplyScalar(r)),s.copy(o).add(ke.multiplyScalar(n)),e.sub(s),e.dot(e)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:t}})),"undefined"!=typeof window&&(window.__THREE__?c("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=t);const Ie=1.25,Ee=65535,Ue=Math.pow(2,-24),Ne=Symbol("SKIP_GENERATION");function Oe(t){return function(t){return t.index?t.index.count:t.attributes.position.count}(t)/3}function qe(t,e){const s=Oe(t),i=e||t.drawRange,r=i.start/3,n=(i.start+i.count)/3,a=Math.max(0,r),o=Math.min(s,n)-a;return[{offset:Math.floor(a),count:Math.floor(o)}]}function Re(t,e){if(!t.groups||!t.groups.length)return qe(t,e);const s=[],i=new Set,r=e||t.drawRange,n=r.start/3,a=(r.start+r.count)/3;for(const e of t.groups){const t=e.start/3,s=(e.start+e.count)/3;i.add(Math.max(n,t)),i.add(Math.min(a,s))}const o=Array.from(i.values()).sort((t,e)=>t-e);for(let t=0;t<o.length-1;t++){const e=o[t],i=o[t+1];s.push({offset:Math.floor(e),count:Math.floor(i-e)})}return s}function We(t,e,s,i,r){let n=1/0,a=1/0,o=1/0,h=-1/0,l=-1/0,c=-1/0,u=1/0,d=1/0,p=1/0,m=-1/0,y=-1/0,f=-1/0;for(let i=6*e,r=6*(e+s);i<r;i+=6){const e=t[i+0],s=t[i+1],r=e-s,x=e+s;r<n&&(n=r),x>h&&(h=x),e<u&&(u=e),e>m&&(m=e);const g=t[i+2],b=t[i+3],w=g-b,_=g+b;w<a&&(a=w),_>l&&(l=_),g<d&&(d=g),g>y&&(y=g);const M=t[i+4],z=t[i+5],S=M-z,A=M+z;S<o&&(o=S),A>c&&(c=A),M<p&&(p=M),M>f&&(f=M)}i[0]=n,i[1]=a,i[2]=o,i[3]=h,i[4]=l,i[5]=c,r[0]=u,r[1]=d,r[2]=p,r[3]=m,r[4]=y,r[5]=f}function De(t,e,s){return s.min.x=e[t],s.min.y=e[t+1],s.min.z=e[t+2],s.max.x=e[t+3],s.max.y=e[t+4],s.max.z=e[t+5],s}function Le(t){let e=-1,s=-1/0;for(let i=0;i<3;i++){const r=t[i+3]-t[i];r>s&&(s=r,e=i)}return e}function je(t,e){e.set(t)}function He(t,e,s){let i,r;for(let n=0;n<3;n++){const a=n+3;i=t[n],r=e[n],s[n]=i<r?i:r,i=t[a],r=e[a],s[a]=i>r?i:r}}function Ye(t,e,s){for(let i=0;i<3;i++){const r=e[t+2*i],n=e[t+2*i+1],a=r-n,o=r+n;a<s[i]&&(s[i]=a),o>s[i+3]&&(s[i+3]=o)}}function Xe(t){const e=t[3]-t[0],s=t[4]-t[1],i=t[5]-t[2];return 2*(e*s+s*i+i*e)}const Ge=(t,e)=>t.candidate-e.candidate,Ze=new Array(32).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Je=new Float32Array(6);class $e{constructor(){this.boundingData=new Float32Array(6)}}function Qe(t,e,s,i,r,n){let a=i,o=i+r-1;const h=n.pos,l=2*n.axis;for(;;){for(;a<=o&&s[6*a+l]<h;)a++;for(;a<=o&&s[6*o+l]>=h;)o--;if(!(a<o))return a;for(let t=0;t<3;t++){let s=e[3*a+t];e[3*a+t]=e[3*o+t],e[3*o+t]=s}for(let t=0;t<6;t++){let e=s[6*a+t];s[6*a+t]=s[6*o+t],s[6*o+t]=e}a++,o--}}function Ke(t,e,s,i,r,n){let a=i,o=i+r-1;const h=n.pos,l=2*n.axis;for(;;){for(;a<=o&&s[6*a+l]<h;)a++;for(;a<=o&&s[6*o+l]>=h;)o--;if(!(a<o))return a;{let e=t[a];t[a]=t[o],t[o]=e;for(let t=0;t<6;t++){let e=s[6*a+t];s[6*a+t]=s[6*o+t],s[6*o+t]=e}a++,o--}}}function ts(t,e){return 65535===e[t+15]}function es(t,e){return e[t+6]}function ss(t,e){return e[t+14]}function is(t){return t+8}function rs(t,e){return e[t+6]}function ns(t,e){return e[t+7]}function as(t){return t}let os,hs,ls,cs;const us=Math.pow(2,32);function ds(t){return"count"in t?1:1+ds(t.left)+ds(t.right)}function ps(t,e,s){return os=new Float32Array(s),hs=new Uint32Array(s),ls=new Uint16Array(s),cs=new Uint8Array(s),ms(t,e)}function ms(t,e){const s=t/4,i=t/2,r="count"in e,n=e.boundingData;for(let t=0;t<6;t++)os[s+t]=n[t];if(r){if(e.buffer){const i=e.buffer;cs.set(new Uint8Array(i),t);for(let e=t,r=t+i.byteLength;e<r;e+=32)ts(e/2,ls)||(hs[e/4+6]+=s);return t+i.byteLength}{const r=e.offset,n=e.count;return hs[s+6]=r,ls[i+14]=n,ls[i+15]=Ee,t+32}}{const i=e.left,r=e.right,n=e.splitAxis;let a;if(a=ms(t+32,i),a/4>us)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return hs[s+6]=a/4,a=ms(a,r),hs[s+7]=n,a}}function ys(t,e){const s=t.geometry;e.indirect&&(t._indirectBuffer=function(t,e){const s=(t.index?t.index.count:t.attributes.position.count)/3,i=s>65536,r=i?4:2,n=e?new SharedArrayBuffer(s*r):new ArrayBuffer(s*r),a=i?new Uint32Array(n):new Uint16Array(n);for(let t=0,e=a.length;t<e;t++)a[t]=t;return a}(s,e.useSharedArrayBuffer),function(t,e){const s=Oe(t),i=Re(t,e).sort((t,e)=>t.offset-e.offset),r=i[i.length-1];r.count=Math.min(s-r.offset,r.count);let n=0;return i.forEach(({count:t})=>n+=t),s!==n}(s,e.range)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),t._indirectBuffer||function(t,e){if(!t.index){const s=t.attributes.position.count,i=function(t,e=ArrayBuffer){return t>65535?new Uint32Array(new e(4*t)):new Uint16Array(new e(2*t))}(s,e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);t.setIndex(new re(i,1));for(let t=0;t<s;t++)i[t]=t}}(s,e);const i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,r=function(t,e=null,s=null,i=null){const r=t.attributes.position,n=t.index?t.index.array:null,a=Oe(t),o=r.normalized;let h;null===e?(h=new Float32Array(6*a),s=0,i=a):(h=e,s=s||0,i=i||a);const l=r.array,c=r.offset||0;let u=3;r.isInterleavedBufferAttribute&&(u=r.data.stride);const d=["getX","getY","getZ"];for(let t=s;t<s+i;t++){const e=3*t,s=6*t;let i=e+0,a=e+1,p=e+2;n&&(i=n[i],a=n[a],p=n[p]),o||(i=i*u+c,a=a*u+c,p=p*u+c);for(let t=0;t<3;t++){let e,n,c;o?(e=r[d[t]](i),n=r[d[t]](a),c=r[d[t]](p)):(e=l[i+t],n=l[a+t],c=l[p+t]);let u=e;n<u&&(u=n),c<u&&(u=c);let m=e;n>m&&(m=n),c>m&&(m=c);const y=(m-u)/2,f=2*t;h[s+f+0]=u+y,h[s+f+1]=y+(Math.abs(u)+y)*Ue}}return h}(s),n=e.indirect?qe(s,e.range):Re(s,e.range);t._roots=n.map(s=>{const n=function(t,e,s,i,r){const{maxDepth:n,verbose:a,maxLeafTris:o,strategy:h,onProgress:l,indirect:c}=r,u=t._indirectBuffer,d=t.geometry,p=d.index?d.index.array:null,m=c?Ke:Qe,y=Oe(d),f=new Float32Array(6);let x=!1;const g=new $e;return We(e,s,i,g.boundingData,f),function t(s,i,r,l=null,c=0){if(!x&&c>=n&&(x=!0,a&&(console.warn(`MeshBVH: Max depth of ${n} reached when generating BVH. Consider increasing maxDepth.`),console.warn(d))),r<=o||c>=n)return b(i+r),s.offset=i,s.count=r,s;const y=function(t,e,s,i,r,n){let a=-1,o=0;if(0===n)a=Le(e),-1!==a&&(o=(e[a]+e[a+3])/2);else if(1===n)a=Le(t),-1!==a&&(o=function(t,e,s,i){let r=0;for(let n=e,a=e+s;n<a;n++)r+=t[6*n+2*i];return r/s}(s,i,r,a));else if(2===n){const n=Xe(t);let h=Ie*r;const l=6*i,c=6*(i+r);for(let t=0;t<3;t++){const i=e[t],u=(e[t+3]-i)/32;if(r<8){const e=[...Ze];e.length=r;let i=0;for(let r=l;r<c;r+=6,i++){const n=e[i];n.candidate=s[r+2*t],n.count=0;const{bounds:a,leftCacheBounds:o,rightCacheBounds:h}=n;for(let t=0;t<3;t++)h[t]=1/0,h[t+3]=-1/0,o[t]=1/0,o[t+3]=-1/0,a[t]=1/0,a[t+3]=-1/0;Ye(r,s,a)}e.sort(Ge);let u=r;for(let t=0;t<u;t++){const s=e[t];for(;t+1<u&&e[t+1].candidate===s.candidate;)e.splice(t+1,1),u--}for(let i=l;i<c;i+=6){const r=s[i+2*t];for(let t=0;t<u;t++){const n=e[t];r>=n.candidate?Ye(i,s,n.rightCacheBounds):(Ye(i,s,n.leftCacheBounds),n.count++)}}for(let s=0;s<u;s++){const i=e[s],l=i.count,c=r-i.count,u=i.leftCacheBounds,d=i.rightCacheBounds;let p=0;0!==l&&(p=Xe(u)/n);let m=0;0!==c&&(m=Xe(d)/n);const y=1+Ie*(p*l+m*c);y<h&&(a=t,h=y,o=i.candidate)}}else{for(let t=0;t<32;t++){const e=Ze[t];e.count=0,e.candidate=i+u+t*u;const s=e.bounds;for(let t=0;t<3;t++)s[t]=1/0,s[t+3]=-1/0}for(let e=l;e<c;e+=6){let r=~~((s[e+2*t]-i)/u);r>=32&&(r=31);const n=Ze[r];n.count++,Ye(e,s,n.bounds)}const e=Ze[31];je(e.bounds,e.rightCacheBounds);for(let t=30;t>=0;t--){const e=Ze[t],s=Ze[t+1];He(e.bounds,s.rightCacheBounds,e.rightCacheBounds)}let d=0;for(let e=0;e<31;e++){const s=Ze[e],i=s.count,l=s.bounds,c=Ze[e+1].rightCacheBounds;0!==i&&(0===d?je(l,Je):He(l,Je,Je)),d+=i;let u=0,p=0;0!==d&&(u=Xe(Je)/n);const m=r-d;0!==m&&(p=Xe(c)/n);const y=1+Ie*(u*d+p*m);y<h&&(a=t,h=y,o=s.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${n} used.`);return{axis:a,pos:o}}(s.boundingData,l,e,i,r,h);if(-1===y.axis)return b(i+r),s.offset=i,s.count=r,s;const g=m(u,p,e,i,r,y);if(g===i||g===i+r)b(i+r),s.offset=i,s.count=r;else{s.splitAxis=y.axis;const n=new $e,a=i,o=g-i;s.left=n,We(e,a,o,n.boundingData,f),t(n,a,o,f,c+1);const h=new $e,l=g,u=r-o;s.right=h,We(e,l,u,h.boundingData,f),t(h,l,u,f,c+1)}return s}(g,s,i,f),g;function b(t){l&&l(t/y)}}(t,r,s.offset,s.count,e),a=ds(n),o=new i(32*a);return ps(0,n,o),o})}class fs{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let s=1/0,i=-1/0;for(let r=0,n=t.length;r<n;r++){const n=t[r][e];s=n<s?n:s,i=n>i?n:i}this.min=s,this.max=i}setFromPoints(t,e){let s=1/0,i=-1/0;for(let r=0,n=e.length;r<n;r++){const n=e[r],a=t.dot(n);s=a<s?a:s,i=a>i?a:i}this.min=s,this.max=i}isSeparated(t){return this.min>t.max||t.min>this.max}}fs.prototype.setFromBox=function(){const t=new M;return function(e,s){const i=s.min,r=s.max;let n=1/0,a=-1/0;for(let s=0;s<=1;s++)for(let o=0;o<=1;o++)for(let h=0;h<=1;h++){t.x=i.x*s+r.x*(1-s),t.y=i.y*o+r.y*(1-o),t.z=i.z*h+r.z*(1-h);const l=e.dot(t);n=Math.min(l,n),a=Math.max(l,a)}this.min=n,this.max=a}}(),new fs;const xs=function(){const t=new M,e=new M,s=new M;return function(i,r,n){const a=i.start,o=t,h=r.start,l=e;s.subVectors(a,h),t.subVectors(i.end,i.start),e.subVectors(r.end,r.start);const c=s.dot(l),u=l.dot(o),d=l.dot(l),p=s.dot(o),m=o.dot(o)*d-u*u;let y,f;y=0!==m?(c*u-p*d)/m:0,f=(c+y*u)/d,n.x=y,n.y=f}}(),gs=function(){const t=new w,e=new M,s=new M;return function(i,r,n,a){xs(i,r,t);let o=t.x,h=t.y;if(o>=0&&o<=1&&h>=0&&h<=1)return i.at(o,n),void r.at(h,a);if(o>=0&&o<=1)return h<0?r.at(0,a):r.at(1,a),void i.closestPointToPoint(a,!0,n);if(h>=0&&h<=1)return o<0?i.at(0,n):i.at(1,n),void r.closestPointToPoint(n,!0,a);{let t,l;t=o<0?i.start:i.end,l=h<0?r.start:r.end;const c=e,u=s;return i.closestPointToPoint(l,!0,e),r.closestPointToPoint(t,!0,s),c.distanceToSquared(l)<=u.distanceToSquared(t)?(n.copy(c),void a.copy(l)):(n.copy(t),void a.copy(u))}}}(),bs=function(){const t=new M,e=new M,s=new he,i=new Fe;return function(r,n){const{radius:a,center:o}=r,{a:h,b:l,c}=n;if(i.start=h,i.end=l,i.closestPointToPoint(o,!0,t).distanceTo(o)<=a)return!0;if(i.start=h,i.end=c,i.closestPointToPoint(o,!0,t).distanceTo(o)<=a)return!0;if(i.start=l,i.end=c,i.closestPointToPoint(o,!0,t).distanceTo(o)<=a)return!0;const u=n.getPlane(s);if(Math.abs(u.distanceToPoint(o))<=a){const t=u.projectPoint(o,e);if(n.containsPoint(t))return!0}return!1}}();function ws(t){return Math.abs(t)<1e-15}class _s extends Gt{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new M),this.satBounds=new Array(4).fill().map(()=>new fs),this.points=[this.a,this.b,this.c],this.sphere=new at,this.plane=new he,this.needsUpdate=!0}intersectsSphere(t){return bs(t,this)}update(){const t=this.a,e=this.b,s=this.c,i=this.points,r=this.satAxes,n=this.satBounds,a=r[0],o=n[0];this.getNormal(a),o.setFromPoints(a,i);const h=r[1],l=n[1];h.subVectors(t,e),l.setFromPoints(h,i);const c=r[2],u=n[2];c.subVectors(e,s),u.setFromPoints(c,i);const d=r[3],p=n[3];d.subVectors(s,t),p.setFromPoints(d,i),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,t),this.needsUpdate=!1}}_s.prototype.closestPointToSegment=function(){const t=new M,e=new M,s=new Fe;return function(i,r=null,n=null){const{start:a,end:o}=i,h=this.points;let l,c=1/0;for(let a=0;a<3;a++){const o=(a+1)%3;s.start.copy(h[a]),s.end.copy(h[o]),gs(s,i,t,e),l=t.distanceToSquared(e),l<c&&(c=l,r&&r.copy(t),n&&n.copy(e))}return this.closestPointToPoint(a,t),l=a.distanceToSquared(t),l<c&&(c=l,r&&r.copy(t),n&&n.copy(a)),this.closestPointToPoint(o,t),l=o.distanceToSquared(t),l<c&&(c=l,r&&r.copy(t),n&&n.copy(o)),Math.sqrt(c)}}(),_s.prototype.intersectsTriangle=function(){const t=new _s,e=new Array(3),s=new Array(3),i=new fs,r=new fs,n=new M,a=new M,o=new M,h=new M,l=new M,c=new Fe,u=new Fe,d=new Fe,p=new M;function m(t,e,s){const i=t.points;let r=0,n=-1;for(let t=0;t<3;t++){const{start:o,end:h}=c;o.copy(i[t]),h.copy(i[(t+1)%3]),c.delta(a);const l=ws(e.distanceToPoint(o));if(ws(e.normal.dot(a))&&l){s.copy(c),r=2;break}const u=e.intersectLine(c,p);if(!u&&l&&p.copy(o),(u||l)&&!ws(p.distanceTo(h))){if(r<=1)(1===r?s.start:s.end).copy(p),l&&(n=r);else if(r>=2){(1===n?s.start:s.end).copy(p),r=2;break}if(r++,2===r&&-1===n)break}}return r}return function(a,c=null,p=!1){this.needsUpdate&&this.update(),a.isExtendedTriangle?a.needsUpdate&&a.update():(t.copy(a),t.update(),a=t);const y=this.plane,f=a.plane;if(Math.abs(y.normal.dot(f.normal))>1-1e-10){const t=this.satBounds,o=this.satAxes;s[0]=a.a,s[1]=a.b,s[2]=a.c;for(let e=0;e<4;e++){const r=t[e],n=o[e];if(i.setFromPoints(n,s),r.isSeparated(i))return!1}const h=a.satBounds,l=a.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let t=0;t<4;t++){const s=h[t],r=l[t];if(i.setFromPoints(r,e),s.isSeparated(i))return!1}for(let t=0;t<4;t++){const a=o[t];for(let t=0;t<4;t++){const o=l[t];if(n.crossVectors(a,o),i.setFromPoints(n,e),r.setFromPoints(n,s),i.isSeparated(r))return!1}}return c&&(p||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),c.start.set(0,0,0),c.end.set(0,0,0)),!0}{const t=m(this,f,u);if(1===t&&a.containsPoint(u.end))return c&&(c.start.copy(u.end),c.end.copy(u.end)),!0;if(2!==t)return!1;const e=m(a,y,d);if(1===e&&this.containsPoint(d.end))return c&&(c.start.copy(d.end),c.end.copy(d.end)),!0;if(2!==e)return!1;if(u.delta(o),d.delta(h),o.dot(h)<0){let t=d.start;d.start=d.end,d.end=t}const s=u.start.dot(o),i=u.end.dot(o),r=d.start.dot(o),n=d.end.dot(o);return(s===n||r===i||i<r!=s<n)&&(c&&(l.subVectors(u.start,d.start),l.dot(o)>0?c.start.copy(u.start):c.start.copy(d.start),l.subVectors(u.end,d.end),l.dot(o)<0?c.end.copy(u.end):c.end.copy(d.end)),!0)}}}(),_s.prototype.distanceToPoint=function(){const t=new M;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),_s.prototype.distanceToTriangle=function(){const t=new M,e=new M,s=["a","b","c"],i=new Fe,r=new Fe;return function(n,a=null,o=null){const h=a||o?i:null;if(this.intersectsTriangle(n,h))return(a||o)&&(a&&h.getCenter(a),o&&h.getCenter(o)),0;let l=1/0;for(let e=0;e<3;e++){let i;const r=s[e],h=n[r];this.closestPointToPoint(h,t),i=h.distanceToSquared(t),i<l&&(l=i,a&&a.copy(t),o&&o.copy(h));const c=this[r];n.closestPointToPoint(c,t),i=c.distanceToSquared(t),i<l&&(l=i,a&&a.copy(c),o&&o.copy(t))}for(let h=0;h<3;h++){const c=s[h],u=s[(h+1)%3];i.set(this[c],this[u]);for(let h=0;h<3;h++){const c=s[h],u=s[(h+1)%3];r.set(n[c],n[u]),gs(i,r,t,e);const d=t.distanceToSquared(e);d<l&&(l=d,a&&a.copy(t),o&&o.copy(e))}}return Math.sqrt(l)}}();class Ms{constructor(t,e,s){this.isOrientedBox=!0,this.min=new M,this.max=new M,this.matrix=new ot,this.invMatrix=new ot,this.points=new Array(8).fill().map(()=>new M),this.satAxes=new Array(3).fill().map(()=>new M),this.satBounds=new Array(3).fill().map(()=>new fs),this.alignedSatBounds=new Array(3).fill().map(()=>new fs),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),s&&this.matrix.copy(s)}set(t,e,s){this.min.copy(t),this.max.copy(e),this.matrix.copy(s),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Ms.prototype.update=function(){const t=this.matrix,e=this.min,s=this.max,i=this.points;for(let r=0;r<=1;r++)for(let n=0;n<=1;n++)for(let a=0;a<=1;a++){const o=i[1*r|2*n|4*a];o.x=r?s.x:e.x,o.y=n?s.y:e.y,o.z=a?s.z:e.z,o.applyMatrix4(t)}const r=this.satBounds,n=this.satAxes,a=i[0];for(let t=0;t<3;t++){const e=n[t],s=r[t],o=i[1<<t];e.subVectors(a,o),s.setFromPoints(e,i)}const o=this.alignedSatBounds;o[0].setFromPointsField(i,"x"),o[1].setFromPointsField(i,"y"),o[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},Ms.prototype.intersectsBox=function(){const t=new fs;return function(e){this.needsUpdate&&this.update();const s=e.min,i=e.max,r=this.satBounds,n=this.satAxes,a=this.alignedSatBounds;if(t.min=s.x,t.max=i.x,a[0].isSeparated(t))return!1;if(t.min=s.y,t.max=i.y,a[1].isSeparated(t))return!1;if(t.min=s.z,t.max=i.z,a[2].isSeparated(t))return!1;for(let s=0;s<3;s++){const i=n[s],a=r[s];if(t.setFromBox(i,e),a.isSeparated(t))return!1}return!0}}(),Ms.prototype.intersectsTriangle=function(){const t=new _s,e=new Array(3),s=new fs,i=new fs,r=new M;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(t.copy(n),t.update(),n=t);const a=this.satBounds,o=this.satAxes;e[0]=n.a,e[1]=n.b,e[2]=n.c;for(let t=0;t<3;t++){const i=a[t],r=o[t];if(s.setFromPoints(r,e),i.isSeparated(s))return!1}const h=n.satBounds,l=n.satAxes,c=this.points;for(let t=0;t<3;t++){const e=h[t],i=l[t];if(s.setFromPoints(i,c),e.isSeparated(s))return!1}for(let t=0;t<3;t++){const n=o[t];for(let t=0;t<4;t++){const a=l[t];if(r.crossVectors(n,a),s.setFromPoints(r,e),i.setFromPoints(r,c),s.isSeparated(i))return!1}}return!0}}(),Ms.prototype.closestPointToPoint=function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e},Ms.prototype.distanceToPoint=function(){const t=new M;return function(e){return this.closestPointToPoint(e,t),e.distanceTo(t)}}(),Ms.prototype.distanceToBox=function(){const t=["x","y","z"],e=new Array(12).fill().map(()=>new Fe),s=new Array(12).fill().map(()=>new Fe),i=new M,r=new M;return function(n,a=0,o=null,h=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(o||h)&&(n.getCenter(r),this.closestPointToPoint(r,i),n.closestPointToPoint(i,r),o&&o.copy(i),h&&h.copy(r)),0;const l=a*a,c=n.min,u=n.max,d=this.points;let p=1/0;for(let t=0;t<8;t++){const e=d[t];r.copy(e).clamp(c,u);const s=e.distanceToSquared(r);if(s<p&&(p=s,o&&o.copy(e),h&&h.copy(r),s<l))return Math.sqrt(s)}let m=0;for(let i=0;i<3;i++)for(let r=0;r<=1;r++)for(let n=0;n<=1;n++){const a=(i+1)%3,o=(i+2)%3,h=1<<i|r<<a|n<<o,l=d[r<<a|n<<o],p=d[h];e[m].set(l,p);const y=t[i],f=t[a],x=t[o],g=s[m],b=g.start,w=g.end;b[y]=c[y],b[f]=r?c[f]:u[f],b[x]=n?c[x]:u[f],w[y]=u[y],w[f]=r?c[f]:u[f],w[x]=n?c[x]:u[f],m++}for(let t=0;t<=1;t++)for(let e=0;e<=1;e++)for(let s=0;s<=1;s++){r.x=t?u.x:c.x,r.y=e?u.y:c.y,r.z=s?u.z:c.z,this.closestPointToPoint(r,i);const n=r.distanceToSquared(i);if(n<p&&(p=n,o&&o.copy(i),h&&h.copy(r),n<l))return Math.sqrt(n)}for(let t=0;t<12;t++){const n=e[t];for(let t=0;t<12;t++){const e=s[t];gs(n,e,i,r);const a=i.distanceToSquared(r);if(a<p&&(p=a,o&&o.copy(i),h&&h.copy(r),a<l))return Math.sqrt(a)}}return Math.sqrt(p)}}();class zs{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return 0===t.length?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class Ss extends zs{constructor(){super(()=>new _s)}}const As=new Ss,vs=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=s=>{e&&t.push(e),e=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==t.length&&this.setBuffer(t.pop())}}};let Ts,Bs;const ks=[],Ps=new zs(()=>new D);function Cs(t,e,s,i,r,n){Ts=Ps.getPrimitive(),Bs=Ps.getPrimitive(),ks.push(Ts,Bs),vs.setBuffer(t._roots[e]);const a=Vs(0,t.geometry,s,i,r,n);vs.clearBuffer(),Ps.releasePrimitive(Ts),Ps.releasePrimitive(Bs),ks.pop(),ks.pop();const o=ks.length;return o>0&&(Bs=ks[o-1],Ts=ks[o-2]),a}function Vs(t,e,s,i,r=null,n=0,a=0){const{float32Array:o,uint16Array:h,uint32Array:l}=vs;let c=2*t;if(ts(c,h)){const u=es(t,l),d=ss(c,h);return De(t,o,Ts),i(u,d,!1,a,n+t,Ts)}{const p=is(t),m=rs(t,l);let y,f,x,g,b=p,w=m;if(r&&(x=Ts,g=Bs,De(b,o,x),De(w,o,g),y=r(x),f=r(g),f<y)){b=m,w=p;const T=y;y=f,f=T,x=g}x||(x=Ts,De(b,o,x));const _=s(x,ts(2*b,h),y,a+1,n+b);let M;if(2===_){const B=A(b);M=i(B,v(b)-B,!0,a+1,n+b,x)}else M=_&&Vs(b,e,s,i,r,n,a+1);if(M)return!0;g=Bs,De(w,o,g);const z=s(g,ts(2*w,h),f,a+1,n+w);let S;if(2===z){const k=A(w);S=i(k,v(w)-k,!0,a+1,n+w,g)}else S=z&&Vs(w,e,s,i,r,n,a+1);return!!S;function A(t){const{uint16Array:e,uint32Array:s}=vs;let i=2*t;for(;!ts(i,e);)i=2*(t=is(t));return es(t,s)}function v(t){const{uint16Array:e,uint32Array:s}=vs;let i=2*t;for(;!ts(i,e);)i=2*(t=rs(t,s));return es(t,s)+ss(i,e)}}}const Fs=new M,Is=new M,Es=parseInt(t)>=169,Us=new M,Ns=new M,Os=new M,qs=new w,Rs=new w,Ws=new w,Ds=new M,Ls=new M,js=new M,Hs=new M;function Ys(t,e,s,i,r,n,a){const o=3*i;let h=o+0,l=o+1,c=o+2;const u=t.index;t.index&&(h=u.getX(h),l=u.getX(l),c=u.getX(c));const{position:d,normal:p,uv:m,uv1:y}=t.attributes,f=function(t,e,s,i,r,n,a,o,h,l,c){Us.fromBufferAttribute(e,n),Ns.fromBufferAttribute(e,a),Os.fromBufferAttribute(e,o);const u=function(t,e,s,i,r,n,a,o){let h;if(h=1===n?t.intersectTriangle(i,s,e,!0,r):t.intersectTriangle(e,s,i,2!==n,r),null===h)return null;const l=t.origin.distanceTo(r);return l<a||l>o?null:{distance:l,point:r.clone()}}(t,Us,Ns,Os,Hs,h,l,c);if(u){const e=new M;Gt.getBarycoord(Hs,Us,Ns,Os,e),i&&(qs.fromBufferAttribute(i,n),Rs.fromBufferAttribute(i,a),Ws.fromBufferAttribute(i,o),u.uv=Gt.getInterpolation(Hs,Us,Ns,Os,qs,Rs,Ws,new w)),r&&(qs.fromBufferAttribute(r,n),Rs.fromBufferAttribute(r,a),Ws.fromBufferAttribute(r,o),u.uv1=Gt.getInterpolation(Hs,Us,Ns,Os,qs,Rs,Ws,new w)),s&&(Ds.fromBufferAttribute(s,n),Ls.fromBufferAttribute(s,a),js.fromBufferAttribute(s,o),u.normal=Gt.getInterpolation(Hs,Us,Ns,Os,Ds,Ls,js,new M),u.normal.dot(t.direction)>0&&u.normal.multiplyScalar(-1));const h={a:n,b:a,c:o,normal:new M,materialIndex:0};Gt.getNormal(Us,Ns,Os,h.normal),u.face=h,u.faceIndex=n,Es&&(u.barycoord=e)}return u}(s,d,p,m,y,h,l,c,e,n,a);return f?(f.faceIndex=i,r&&r.push(f),f):null}function Xs(t,e,s,i){const r=t.a,n=t.b,a=t.c;let o=e,h=e+1,l=e+2;s&&(o=s.getX(o),h=s.getX(h),l=s.getX(l)),r.x=i.getX(o),r.y=i.getY(o),r.z=i.getZ(o),n.x=i.getX(h),n.y=i.getY(h),n.z=i.getZ(h),a.x=i.getX(l),a.y=i.getY(l),a.z=i.getZ(l)}function Gs(t,e,s,i,r,n,a){const{geometry:o}=s,{index:h}=o,l=o.attributes.position;for(let s=t,o=e+t;s<o;s++){let t;if(t=s,Xs(a,3*t,h,l),a.needsUpdate=!0,i(a,t,r,n))return!0}return!1}function Zs(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const s=t.geometry,i=s.index?s.index.array:null,r=s.attributes.position;let n,a,o,h,l=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)n=c[t],a=new Uint32Array(n),o=new Uint16Array(n),h=new Float32Array(n),u(0,l),l+=n.byteLength;function u(t,s,n=!1){const l=2*t;if(o[l+15]===Ee){const e=a[t+6];let s=1/0,n=1/0,c=1/0,u=-1/0,d=-1/0,p=-1/0;for(let t=3*e,a=3*(e+o[l+14]);t<a;t++){let e=i[t];const a=r.getX(e),o=r.getY(e),h=r.getZ(e);a<s&&(s=a),a>u&&(u=a),o<n&&(n=o),o>d&&(d=o),h<c&&(c=h),h>p&&(p=h)}return(h[t+0]!==s||h[t+1]!==n||h[t+2]!==c||h[t+3]!==u||h[t+4]!==d||h[t+5]!==p)&&(h[t+0]=s,h[t+1]=n,h[t+2]=c,h[t+3]=u,h[t+4]=d,h[t+5]=p,!0)}{const i=t+8,r=a[t+6],o=i+s,l=r+s;let c=n,d=!1,p=!1;e?c||(d=e.has(o),p=e.has(l),c=!d&&!p):(d=!0,p=!0);const m=c||p;let y=!1;(c||d)&&(y=u(i,s,c));let f=!1;m&&(f=u(r,s,c));const x=y||f;if(x)for(let e=0;e<3;e++){const s=i+e,n=r+e,a=h[s],o=h[s+3],l=h[n],c=h[n+3];h[t+e]=a<l?a:l,h[t+e+3]=o>c?o:c}return x}}}function Js(t,e,s,i,r){let n,a,o,h,l,c;const u=1/s.direction.x,d=1/s.direction.y,p=1/s.direction.z,m=s.origin.x,y=s.origin.y,f=s.origin.z;let x=e[t],g=e[t+3],b=e[t+1],w=e[t+3+1],_=e[t+2],M=e[t+3+2];return u>=0?(n=(x-m)*u,a=(g-m)*u):(n=(g-m)*u,a=(x-m)*u),d>=0?(o=(b-y)*d,h=(w-y)*d):(o=(w-y)*d,h=(b-y)*d),!(n>h||o>a)&&((o>n||isNaN(n))&&(n=o),(h<a||isNaN(a))&&(a=h),p>=0?(l=(_-f)*p,c=(M-f)*p):(l=(M-f)*p,c=(_-f)*p),!(n>c||l>a)&&((l>n||n!=n)&&(n=l),(c<a||a!=a)&&(a=c),n<=r&&a>=i))}function $s(t,e,s,i,r,n,a){vs.setBuffer(t._roots[e]),Qs(0,t,s,i,r,n,a),vs.clearBuffer()}function Qs(t,e,s,i,r,n,a){const{float32Array:o,uint16Array:h,uint32Array:l}=vs,c=2*t;if(ts(c,h))!function(t,e,s,i,r,n,a,o){const{geometry:h,_indirectBuffer:l}=t;for(let t=i,l=i+r;t<l;t++)Ys(h,e,s,t,n,a,o)}(e,s,i,es(t,l),ss(c,h),r,n,a);else{const h=is(t);Js(h,o,i,n,a)&&Qs(h,e,s,i,r,n,a);const c=rs(t,l);Js(c,o,i,n,a)&&Qs(c,e,s,i,r,n,a)}}const Ks=["x","y","z"];function ti(t,e,s,i,r,n){vs.setBuffer(t._roots[e]);const a=ei(0,t,s,i,r,n);return vs.clearBuffer(),a}function ei(t,e,s,i,r,n){const{float32Array:a,uint16Array:o,uint32Array:h}=vs;let l=2*t;if(ts(l,o))return function(t,e,s,i,r,n,a){const{geometry:o,_indirectBuffer:h}=t;let l=1/0,c=null;for(let t=i,h=i+r;t<h;t++){let i;i=Ys(o,e,s,t,null,n,a),i&&i.distance<l&&(c=i,l=i.distance)}return c}(e,s,i,es(t,h),ss(l,o),r,n);{const o=ns(t,h),l=Ks[o],c=i.direction[l]>=0;let u,d;c?(u=is(t),d=rs(t,h)):(u=rs(t,h),d=is(t));const p=Js(u,a,i,r,n)?ei(u,e,s,i,r,n):null;if(p){const t=p.point[l];if(c?t<=a[d+o]:t>=a[d+o+3])return p}const m=Js(d,a,i,r,n)?ei(d,e,s,i,r,n):null;return p&&m?p.distance<=m.distance?p:m:p||m||null}}const si=new D,ii=new _s,ri=new _s,ni=new ot,ai=new Ms,oi=new Ms;function hi(t,e,s,i){vs.setBuffer(t._roots[e]);const r=li(0,t,s,i);return vs.clearBuffer(),r}function li(t,e,s,i,r=null){const{float32Array:n,uint16Array:a,uint32Array:o}=vs;let h=2*t;if(null===r&&(s.boundingBox||s.computeBoundingBox(),ai.set(s.boundingBox.min,s.boundingBox.max,i),r=ai),!ts(h,a)){const a=t+8,h=o[t+6];return De(a,n,si),r.intersectsBox(si)&&li(a,e,s,i,r)?!0:(De(h,n,si),!(!r.intersectsBox(si)||!li(h,e,s,i,r)))}{const r=e.geometry,l=r.index,c=r.attributes.position,u=s.index,d=s.attributes.position,p=es(t,o),m=ss(h,a);if(ni.copy(i).invert(),s.boundsTree)return De(t,n,oi),oi.matrix.copy(ni),oi.needsUpdate=!0,s.boundsTree.shapecast({intersectsBounds:t=>oi.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(i),t.b.applyMatrix4(i),t.c.applyMatrix4(i),t.needsUpdate=!0;for(let e=3*p,s=3*(m+p);e<s;e+=3)if(Xs(ri,e,l,c),ri.needsUpdate=!0,t.intersectsTriangle(ri))return!0;return!1}});for(let t=3*p,e=3*(m+p);t<e;t+=3){Xs(ii,t,l,c),ii.a.applyMatrix4(ni),ii.b.applyMatrix4(ni),ii.c.applyMatrix4(ni),ii.needsUpdate=!0;for(let t=0,e=u.count;t<e;t+=3)if(Xs(ri,t,u,d),ri.needsUpdate=!0,ii.intersectsTriangle(ri))return!0}}}const ci=new ot,ui=new Ms,di=new Ms,pi=new M,mi=new M,yi=new M,fi=new M;function xi(t,e,s,i={},r={},n=0,a=1/0){e.boundingBox||e.computeBoundingBox(),ui.set(e.boundingBox.min,e.boundingBox.max,s),ui.needsUpdate=!0;const o=t.geometry,h=o.attributes.position,l=o.index,c=e.attributes.position,u=e.index,d=As.getPrimitive(),p=As.getPrimitive();let m=pi,y=mi,f=null,x=null;r&&(f=yi,x=fi);let g=1/0,b=null,w=null;return ci.copy(s).invert(),di.matrix.copy(ci),t.shapecast({boundsTraverseOrder:t=>ui.distanceToBox(t),intersectsBounds:(t,e,s)=>s<g&&s<a&&(e&&(di.min.copy(t.min),di.max.copy(t.max),di.needsUpdate=!0),!0),intersectsRange:(t,i)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:t=>di.distanceToBox(t),intersectsBounds:(t,e,s)=>s<g&&s<a,intersectsRange:(e,r)=>{for(let a=e,o=e+r;a<o;a++){Xs(p,3*a,u,c),p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let e=t,s=t+i;e<s;e++){Xs(d,3*e,l,h),d.needsUpdate=!0;const t=d.distanceToTriangle(p,m,f);if(t<g&&(y.copy(m),x&&x.copy(f),g=t,b=e,w=a),t<n)return!0}}}});for(let r=0,a=Oe(e);r<a;r++){Xs(p,3*r,u,c),p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let e=t,s=t+i;e<s;e++){Xs(d,3*e,l,h),d.needsUpdate=!0;const t=d.distanceToTriangle(p,m,f);if(t<g&&(y.copy(m),x&&x.copy(f),g=t,b=e,w=r),t<n)return!0}}}}),As.releasePrimitive(d),As.releasePrimitive(p),g===1/0?null:(i.point?i.point.copy(y):i.point=y.clone(),i.distance=g,i.faceIndex=b,r&&(r.point?r.point.copy(x):r.point=x.clone(),r.point.applyMatrix4(ci),y.applyMatrix4(ci),r.distance=y.sub(r.point).length(),r.faceIndex=w),i)}function gi(t,e,s,i,r,n,a){const{geometry:o}=s,{index:h}=o,l=o.attributes.position;for(let o=t,c=e+t;o<c;o++){let t;if(t=s.resolveTriangleIndex(o),Xs(a,3*t,h,l),a.needsUpdate=!0,i(a,t,r,n))return!0}return!1}function bi(t,e=null){e&&Array.isArray(e)&&(e=new Set(e));const s=t.geometry,i=s.index?s.index.array:null,r=s.attributes.position;let n,a,o,h,l=0;const c=t._roots;for(let t=0,e=c.length;t<e;t++)n=c[t],a=new Uint32Array(n),o=new Uint16Array(n),h=new Float32Array(n),u(0,l),l+=n.byteLength;function u(s,n,l=!1){const c=2*s;if(o[c+15]===Ee){const e=a[s+6];let n=1/0,l=1/0,u=1/0,d=-1/0,p=-1/0,m=-1/0;for(let s=e,a=e+o[c+14];s<a;s++){const e=3*t.resolveTriangleIndex(s);for(let t=0;t<3;t++){let s=e+t;s=i?i[s]:s;const a=r.getX(s),o=r.getY(s),h=r.getZ(s);a<n&&(n=a),a>d&&(d=a),o<l&&(l=o),o>p&&(p=o),h<u&&(u=h),h>m&&(m=h)}}return(h[s+0]!==n||h[s+1]!==l||h[s+2]!==u||h[s+3]!==d||h[s+4]!==p||h[s+5]!==m)&&(h[s+0]=n,h[s+1]=l,h[s+2]=u,h[s+3]=d,h[s+4]=p,h[s+5]=m,!0)}{const t=s+8,i=a[s+6],r=t+n,o=i+n;let c=l,d=!1,p=!1;e?c||(d=e.has(r),p=e.has(o),c=!d&&!p):(d=!0,p=!0);const m=c||p;let y=!1;(c||d)&&(y=u(t,n,c));let f=!1;m&&(f=u(i,n,c));const x=y||f;if(x)for(let e=0;e<3;e++){const r=t+e,n=i+e,a=h[r],o=h[r+3],l=h[n],c=h[n+3];h[s+e]=a<l?a:l,h[s+e+3]=o>c?o:c}return x}}}function wi(t,e,s,i,r,n,a){vs.setBuffer(t._roots[e]),_i(0,t,s,i,r,n,a),vs.clearBuffer()}function _i(t,e,s,i,r,n,a){const{float32Array:o,uint16Array:h,uint32Array:l}=vs,c=2*t;if(ts(c,h))!function(t,e,s,i,r,n,a,o){const{geometry:h,_indirectBuffer:l}=t;for(let t=i,c=i+r;t<c;t++)Ys(h,e,s,l?l[t]:t,n,a,o)}(e,s,i,es(t,l),ss(c,h),r,n,a);else{const h=is(t);Js(h,o,i,n,a)&&_i(h,e,s,i,r,n,a);const c=rs(t,l);Js(c,o,i,n,a)&&_i(c,e,s,i,r,n,a)}}const Mi=["x","y","z"];function zi(t,e,s,i,r,n){vs.setBuffer(t._roots[e]);const a=Si(0,t,s,i,r,n);return vs.clearBuffer(),a}function Si(t,e,s,i,r,n){const{float32Array:a,uint16Array:o,uint32Array:h}=vs;let l=2*t;if(ts(l,o))return function(t,e,s,i,r,n,a){const{geometry:o,_indirectBuffer:h}=t;let l=1/0,c=null;for(let t=i,u=i+r;t<u;t++){let i;i=Ys(o,e,s,h?h[t]:t,null,n,a),i&&i.distance<l&&(c=i,l=i.distance)}return c}(e,s,i,es(t,h),ss(l,o),r,n);{const o=ns(t,h),l=Mi[o],c=i.direction[l]>=0;let u,d;c?(u=is(t),d=rs(t,h)):(u=rs(t,h),d=is(t));const p=Js(u,a,i,r,n)?Si(u,e,s,i,r,n):null;if(p){const t=p.point[l];if(c?t<=a[d+o]:t>=a[d+o+3])return p}const m=Js(d,a,i,r,n)?Si(d,e,s,i,r,n):null;return p&&m?p.distance<=m.distance?p:m:p||m||null}}const Ai=new D,vi=new _s,Ti=new _s,Bi=new ot,ki=new Ms,Pi=new Ms;function Ci(t,e,s,i){vs.setBuffer(t._roots[e]);const r=Vi(0,t,s,i);return vs.clearBuffer(),r}function Vi(t,e,s,i,r=null){const{float32Array:n,uint16Array:a,uint32Array:o}=vs;let h=2*t;if(null===r&&(s.boundingBox||s.computeBoundingBox(),ki.set(s.boundingBox.min,s.boundingBox.max,i),r=ki),!ts(h,a)){const a=t+8,h=o[t+6];return De(a,n,Ai),r.intersectsBox(Ai)&&Vi(a,e,s,i,r)?!0:(De(h,n,Ai),!(!r.intersectsBox(Ai)||!Vi(h,e,s,i,r)))}{const r=e.geometry,l=r.index,c=r.attributes.position,u=s.index,d=s.attributes.position,p=es(t,o),m=ss(h,a);if(Bi.copy(i).invert(),s.boundsTree)return De(t,n,Pi),Pi.matrix.copy(Bi),Pi.needsUpdate=!0,s.boundsTree.shapecast({intersectsBounds:t=>Pi.intersectsBox(t),intersectsTriangle:t=>{t.a.applyMatrix4(i),t.b.applyMatrix4(i),t.c.applyMatrix4(i),t.needsUpdate=!0;for(let s=p,i=m+p;s<i;s++)if(Xs(Ti,3*e.resolveTriangleIndex(s),l,c),Ti.needsUpdate=!0,t.intersectsTriangle(Ti))return!0;return!1}});for(let t=p,s=m+p;t<s;t++){const s=e.resolveTriangleIndex(t);Xs(vi,3*s,l,c),vi.a.applyMatrix4(Bi),vi.b.applyMatrix4(Bi),vi.c.applyMatrix4(Bi),vi.needsUpdate=!0;for(let t=0,e=u.count;t<e;t+=3)if(Xs(Ti,t,u,d),Ti.needsUpdate=!0,vi.intersectsTriangle(Ti))return!0}}}const Fi=new ot,Ii=new Ms,Ei=new Ms,Ui=new M,Ni=new M,Oi=new M,qi=new M;function Ri(t,e,s,i={},r={},n=0,a=1/0){e.boundingBox||e.computeBoundingBox(),Ii.set(e.boundingBox.min,e.boundingBox.max,s),Ii.needsUpdate=!0;const o=t.geometry,h=o.attributes.position,l=o.index,c=e.attributes.position,u=e.index,d=As.getPrimitive(),p=As.getPrimitive();let m=Ui,y=Ni,f=null,x=null;r&&(f=Oi,x=qi);let g=1/0,b=null,w=null;return Fi.copy(s).invert(),Ei.matrix.copy(Fi),t.shapecast({boundsTraverseOrder:t=>Ii.distanceToBox(t),intersectsBounds:(t,e,s)=>s<g&&s<a&&(e&&(Ei.min.copy(t.min),Ei.max.copy(t.max),Ei.needsUpdate=!0),!0),intersectsRange:(i,r)=>{if(e.boundsTree){const o=e.boundsTree;return o.shapecast({boundsTraverseOrder:t=>Ei.distanceToBox(t),intersectsBounds:(t,e,s)=>s<g&&s<a,intersectsRange:(e,a)=>{for(let _=e,M=e+a;_<M;_++){const e=o.resolveTriangleIndex(_);Xs(p,3*e,u,c),p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let e=i,s=i+r;e<s;e++){const s=t.resolveTriangleIndex(e);Xs(d,3*s,l,h),d.needsUpdate=!0;const i=d.distanceToTriangle(p,m,f);if(i<g&&(y.copy(m),x&&x.copy(f),g=i,b=e,w=_),i<n)return!0}}}})}for(let a=0,o=Oe(e);a<o;a++){Xs(p,3*a,u,c),p.a.applyMatrix4(s),p.b.applyMatrix4(s),p.c.applyMatrix4(s),p.needsUpdate=!0;for(let e=i,s=i+r;e<s;e++){const s=t.resolveTriangleIndex(e);Xs(d,3*s,l,h),d.needsUpdate=!0;const i=d.distanceToTriangle(p,m,f);if(i<g&&(y.copy(m),x&&x.copy(f),g=i,b=e,w=a),i<n)return!0}}}}),As.releasePrimitive(d),As.releasePrimitive(p),g===1/0?null:(i.point?i.point.copy(y):i.point=y.clone(),i.distance=g,i.faceIndex=b,r&&(r.point?r.point.copy(x):r.point=x.clone(),r.point.applyMatrix4(Fi),y.applyMatrix4(Fi),r.distance=y.sub(r.point).length(),r.faceIndex=w),i)}const Wi=new vs.constructor,Di=new vs.constructor,Li=new zs(()=>new D),ji=new D,Hi=new D,Yi=new D,Xi=new D;let Gi=!1;function Zi(t,e,s,i,r,n=0,a=0,o=0,h=0,l=null,c=!1){let u,d;c?(u=Di,d=Wi):(u=Wi,d=Di);const p=u.float32Array,m=u.uint32Array,y=u.uint16Array,f=d.float32Array,x=d.uint32Array,g=d.uint16Array,b=2*e,w=ts(2*t,y),_=ts(b,g);let M=!1;if(_&&w)M=c?r(es(e,x),ss(2*e,g),es(t,m),ss(2*t,y),h,a+e,o,n+t):r(es(t,m),ss(2*t,y),es(e,x),ss(2*e,g),o,n+t,h,a+e);else if(_){const l=Li.getPrimitive();De(e,f,l),l.applyMatrix4(s);const u=is(t),d=rs(t,m);De(u,p,ji),De(d,p,Hi);const y=l.intersectsBox(ji),x=l.intersectsBox(Hi);M=y&&Zi(e,u,i,s,r,a,n,h,o+1,l,!c)||x&&Zi(e,d,i,s,r,a,n,h,o+1,l,!c),Li.releasePrimitive(l)}else{const u=is(e),d=rs(e,x);De(u,f,Yi),De(d,f,Xi);const y=l.intersectsBox(Yi),g=l.intersectsBox(Xi);if(y&&g)M=Zi(t,u,s,i,r,n,a,o,h+1,l,c)||Zi(t,d,s,i,r,n,a,o,h+1,l,c);else if(y)if(w)M=Zi(t,u,s,i,r,n,a,o,h+1,l,c);else{const e=Li.getPrimitive();e.copy(Yi).applyMatrix4(s);const l=is(t),d=rs(t,m);De(l,p,ji),De(d,p,Hi);const y=e.intersectsBox(ji),f=e.intersectsBox(Hi);M=y&&Zi(u,l,i,s,r,a,n,h,o+1,e,!c)||f&&Zi(u,d,i,s,r,a,n,h,o+1,e,!c),Li.releasePrimitive(e)}else if(g)if(w)M=Zi(t,d,s,i,r,n,a,o,h+1,l,c);else{const e=Li.getPrimitive();e.copy(Xi).applyMatrix4(s);const l=is(t),u=rs(t,m);De(l,p,ji),De(u,p,Hi);const y=e.intersectsBox(ji),f=e.intersectsBox(Hi);M=y&&Zi(d,l,i,s,r,a,n,h,o+1,e,!c)||f&&Zi(d,u,i,s,r,a,n,h,o+1,e,!c),Li.releasePrimitive(e)}}return M}const Ji=new Ms,$i=new D,Qi={strategy:0,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class Ki{static serialize(t,e={}){e={cloneBuffers:!0,...e};const s=t.geometry,i=t._roots,r=t._indirectBuffer,n=s.getIndex();let a;return a=e.cloneBuffers?{roots:i.map(t=>t.slice()),index:n?n.array.slice():null,indirectBuffer:r?r.slice():null}:{roots:i,index:n?n.array:null,indirectBuffer:r},a}static deserialize(t,e,s={}){s={setIndex:!0,indirect:Boolean(t.indirectBuffer),...s};const{index:i,roots:r,indirectBuffer:n}=t,a=new Ki(e,{...s,[Ne]:!0});if(a._roots=r,a._indirectBuffer=n||null,s.setIndex){const s=e.getIndex();if(null===s){const s=new re(t.index,1,!1);e.setIndex(s)}else s.array!==i&&(s.array.set(i),s.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(!t.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((e=Object.assign({...Qi,[Ne]:!1},e)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[Ne]||(ys(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new D))),this.resolveTriangleIndex=e.indirect?t=>this._indirectBuffer[t]:t=>t}refit(t=null){return(this.indirect?bi:Zs)(this,t)}traverse(t,e=0){const s=this._roots[e],i=new Uint32Array(s),r=new Uint16Array(s);!function e(n,a=0){const o=2*n,h=r[o+15]===Ee;if(h){const e=i[n+6],l=r[o+14];t(a,h,new Float32Array(s,4*n,6),e,l)}else{const r=n+8,o=i[n+6],l=i[n+7];t(a,h,new Float32Array(s,4*n,6),l)||(e(r,a+1),e(o,a+1))}}(0)}raycast(t,e=0,s=0,i=1/0){const r=this._roots,n=this.geometry,a=[],o=e.isMaterial,h=Array.isArray(e),l=n.groups,c=o?e.side:e,u=this.indirect?wi:$s;for(let n=0,o=r.length;n<o;n++){const r=h?e[l[n].materialIndex].side:c,o=a.length;if(u(this,n,r,t,a,s,i),h){const t=l[n].materialIndex;for(let e=o,s=a.length;e<s;e++)a[e].face.materialIndex=t}}return a}raycastFirst(t,e=0,s=0,i=1/0){const r=this._roots,n=this.geometry,a=e.isMaterial,o=Array.isArray(e);let h=null;const l=n.groups,c=a?e.side:e,u=this.indirect?zi:ti;for(let n=0,a=r.length;n<a;n++){const r=u(this,n,o?e[l[n].materialIndex].side:c,t,s,i);null!=r&&(null==h||r.distance<h.distance)&&(h=r,o&&(r.face.materialIndex=l[n].materialIndex))}return h}intersectsGeometry(t,e){let s=!1;const i=this._roots,r=this.indirect?Ci:hi;for(let n=0,a=i.length;n<a&&(s=r(this,n,t,e),!s);n++);return s}shapecast(t){const e=As.getPrimitive(),s=this.indirect?gi:Gs;let{boundsTraverseOrder:i,intersectsBounds:r,intersectsRange:n,intersectsTriangle:a}=t;if(n&&a){const t=n;n=(i,r,n,o,h)=>!!t(i,r,n,o,h)||s(i,r,this,a,n,o,e)}else n||(n=a?(t,i,r,n)=>s(t,i,this,a,r,n,e):(t,e,s)=>s);let o=!1,h=0;const l=this._roots;for(let t=0,e=l.length;t<e;t++){const e=l[t];if(o=Cs(this,t,r,n,i,h),o)break;h+=e.byteLength}return As.releasePrimitive(e),o}bvhcast(t,e,s){let{intersectsRanges:i,intersectsTriangles:r}=s;const n=As.getPrimitive(),a=this.geometry.index,o=this.geometry.attributes.position,h=this.indirect?t=>{const e=this.resolveTriangleIndex(t);Xs(n,3*e,a,o)}:t=>{Xs(n,3*t,a,o)},l=As.getPrimitive(),c=t.geometry.index,u=t.geometry.attributes.position,d=t.indirect?e=>{const s=t.resolveTriangleIndex(e);Xs(l,3*s,c,u)}:t=>{Xs(l,3*t,c,u)};if(r){const t=(t,s,i,a,o,c,u,p)=>{for(let m=i,y=i+a;m<y;m++){d(m),l.a.applyMatrix4(e),l.b.applyMatrix4(e),l.c.applyMatrix4(e),l.needsUpdate=!0;for(let e=t,i=t+s;e<i;e++)if(h(e),n.needsUpdate=!0,r(n,l,e,m,o,c,u,p))return!0}return!1};if(i){const e=i;i=function(s,i,r,n,a,o,h,l){return!!e(s,i,r,n,a,o,h,l)||t(s,i,r,n,a,o,h,l)}}else i=t}return function(t,e,s,i){if(Gi)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Gi=!0;const r=t._roots,n=e._roots;let a,o=0,h=0;const l=(new ot).copy(s).invert();for(let t=0,e=r.length;t<e;t++){Wi.setBuffer(r[t]),h=0;const e=Li.getPrimitive();De(as(0),Wi.float32Array,e),e.applyMatrix4(l);for(let t=0,r=n.length;t<r&&(Di.setBuffer(n[t]),a=Zi(0,0,s,l,i,o,h,0,0,e),Di.clearBuffer(),h+=n[t].length,!a);t++);if(Li.releasePrimitive(e),Wi.clearBuffer(),o+=r[t].length,a)break}return Gi=!1,a}(this,t,e,i)}intersectsBox(t,e){return Ji.set(t.min,t.max,e),Ji.needsUpdate=!0,this.shapecast({intersectsBounds:t=>Ji.intersectsBox(t),intersectsTriangle:t=>Ji.intersectsTriangle(t)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,s={},i={},r=0,n=1/0){return(this.indirect?Ri:xi)(this,t,e,s,i,r,n)}closestPointToPoint(t,e={},s=0,i=1/0){return function(t,e,s={},i=0,r=1/0){const n=i*i,a=r*r;let o=1/0,h=null;if(t.shapecast({boundsTraverseOrder:t=>(Fs.copy(e).clamp(t.min,t.max),Fs.distanceToSquared(e)),intersectsBounds:(t,e,s)=>s<o&&s<a,intersectsTriangle:(t,s)=>{t.closestPointToPoint(e,Fs);const i=e.distanceToSquared(Fs);return i<o&&(Is.copy(Fs),o=i,h=s),i<n}}),o===1/0)return null;const l=Math.sqrt(o);return s.point?s.point.copy(Is):s.point=Is.clone(),s.distance=l,s.faceIndex=h,s}(this,t,e,s,i)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(e=>{De(0,new Float32Array(e),$i),t.union($i)}),t}}let tr;function er(t){return`#${Math.round(t.r).toString(16).padStart(2,"0")}${Math.round(t.g).toString(16).padStart(2,"0")}${Math.round(t.b).toString(16).padStart(2,"0")}`}function sr(t,e){return{r:parseInt(t.slice(1,3),16),g:parseInt(t.slice(3,5),16),b:parseInt(t.slice(5,7),16),a:e}}function ir(){if(0===Mesh.selected.length)return void Blockbench.showToastNotification({text:"No meshes selected"});if(Mesh.selected.length>1)return void Blockbench.showToastNotification({text:"Multiple meshes selected"});const t=function(){const t=localStorage.getItem("blockbench_baked_ao_settings"),e={sampleMethod:"random",highlightColor:{r:231,g:230,b:184,a:.3},shadowColor:{r:36,g:11,b:55,a:.5},samples:1e3,aoShadowSize:32,aoHighlightSize:8,retainTextureTransparency:!1,sampleTextureTransparency:!1,shadowGamma:1,highlightGamma:.5,simulateGroundPlane:!0};if(t)try{return{...e,...JSON.parse(t)}}catch(t){console.warn("Failed to parse saved AO settings, using defaults")}return e}();new Dialog("ambient_occlusion_config",{title:"Ambient Occlusion Settings",form:{highlight_color:{label:"Highlight Color",type:"color",value:er(t.highlightColor),description:"Color used for areas with high ambient lighting"},highlight_alpha:{label:"Highlight Opacity",type:"range",min:0,max:1,step:.01,value:t.highlightColor.a,description:"Opacity of the highlight color overlay"},highlight_gamma:{label:"Highlight Softness",type:"range",min:.2,max:2,step:.1,value:t.highlightGamma,description:"Gamma correction for highlight areas (lower = more contrast)"},ao_highlight_size:{label:"Highlight Size",type:"number",min:1,max:64,step:1,value:t.aoHighlightSize,description:"Ray distance for highlight detection (rays going into the surface)"},shadow_color:{label:"Shadow Color",type:"color",value:er(t.shadowColor),description:"Color used for occluded/shadowed areas"},shadow_alpha:{label:"Shadow Opacity",type:"range",min:0,max:1,step:.01,value:t.shadowColor.a,description:"Opacity of the shadow color overlay"},shadow_gamma:{label:"Shadow Softness",type:"range",min:.2,max:2,step:.1,value:t.shadowGamma,description:"Gamma correction for shadow areas (higher = softer shadows)"},ao_shadow_size:{label:"Shadow Size",type:"number",min:1,max:64,step:1,value:t.aoShadowSize,description:"Ray distance for shadow detection (rays going away from the surface)"},samples:{label:"Samples per pixel",type:"number",min:10,max:1e4,step:100,value:t.samples,description:"Number of samples per pixel (higher = better quality, slower). 100 recommended for uniform sampling, 1000 for random sampling."},sample_method:{label:"Sample Method",type:"inline_select",options:{random:"Random",uniform:"Uniform"},value:t.sampleMethod,description:"Method for sampling ambient occlusion rays. Random is slightly more accurate but noisier, uniform is smoother for less samples but is more prone to artifacts."},simulate_ground_plane:{label:"Simulate Ground Plane",type:"checkbox",value:t.simulateGroundPlane,description:"Simulate a ground plane, adding shadows at the base of the model"},retain_texture_transparency:{label:"Retain Texture Transparency",type:"checkbox",value:t.retainTextureTransparency,description:"Preserve the original transparency of textures"},sample_texture_transparency:{label:"Sample Texture Transparency",type:"checkbox",value:t.sampleTextureTransparency,description:"Consider texture transparency when calculating occlusion (slower but more accurate)"}},onConfirm:async function(t){const e={onProgress:t=>{Blockbench.setProgress(t),r.progress_bar.setProgress(t);const e=performance.now()-s,i=r.object.querySelector(".dialog_title");if(i)if(e>3e3||t>.2){const s=function(t){const e=Math.floor(t/1e3),s=Math.floor(e/60),i=e%60,r=s%60,n=Math.floor(s/60);return n>0?`${n}h ${r}m ${i}s`:r>0?`${r}m ${i}s`:`${i}s`}(e/t-e);i.textContent=`Baking Ambient Occlusion (~ ${s} remaining)`}else i.textContent="Baking Ambient Occlusion"},highlightColor:sr("#"+t.highlight_color.toHex(),t.highlight_alpha),shadowColor:sr("#"+t.shadow_color.toHex(),t.shadow_alpha),samples:t.samples,aoShadowSize:t.ao_shadow_size,aoHighlightSize:t.ao_highlight_size,retainTextureTransparency:t.retain_texture_transparency,sampleTextureTransparency:t.sample_texture_transparency,shadowGamma:t.shadow_gamma,highlightGamma:t.highlight_gamma,simulateGroundPlane:t.simulate_ground_plane,sampleMethod:t.sample_method};!function(t){localStorage.setItem("blockbench_baked_ao_settings",JSON.stringify(t))}({highlightColor:e.highlightColor,shadowColor:e.shadowColor,samples:e.samples,aoShadowSize:e.aoShadowSize,aoHighlightSize:e.aoHighlightSize,retainTextureTransparency:e.retainTextureTransparency,sampleTextureTransparency:e.sampleTextureTransparency,shadowGamma:e.shadowGamma,highlightGamma:e.highlightGamma,simulateGroundPlane:e.simulateGroundPlane,sampleMethod:e.sampleMethod});const s=performance.now(),i={cancelled:!1},r=new Dialog("bake_ambient_occlusion_loading",{title:"Baking Ambient Occlusion",progress_bar:{progress:0},cancel_on_click_outside:!1,singleButton:!0,buttons:["Cancel"],onCancel:function(){i.cancelled=!0}});r.show();try{await async function(t,e){let s=!1,i=!1,r=0,n=0;performance.mark("startAO");for(const a of Mesh.selected){let o=!1,h=0;a.forAllFaces(t=>{t.isSelected()&&(o=!0),h++});const l=await rr(a,o,t,e);s=s||l.anyMissing,i=i||l.anyWithTextures,r+=l.totalPixelsProcessed,n+=l.totalFacesProcessed}performance.mark("endAO");const a=performance.measure("AO Processing Time","startAO","endAO");console.log(`AO Processing Time: ${a.duration}ms`),i?s&&Blockbench.showToastNotification({text:"Some faces are missing textures"}):Blockbench.showToastNotification({text:"No textures found on selected meshes"})}(e,i)}finally{r.hide(),Blockbench.setProgress(0)}},buttons:["Confirm","Restore Defaults","Cancel"],onButton(t,e){1===t&&(localStorage.removeItem("blockbench_baked_ao_settings"),ir())}}).show()}async function rr(t,e,s,i){let r=!1,n=!1,a=0,o=0;const h=[];t.forAllFaces(t=>h.push(t));const l=new Map;for(const t of h){const s=t.getTexture();s?e&&!t.isSelected()||(n=!0,l.has(s)||l.set(s,[]),l.get(s).push(t)):r=!0}const[c]=function(t){if(!(t.mesh&&t.mesh instanceof THREE.Mesh))throw console.log(t),new Error("Invalid mesh object");const e=t.mesh.geometry;if(!e||!e.attributes||!e.attributes.position)throw console.log(e),new Error("Mesh does not have valid geometry attributes");const s=e.attributes.position;let i=-1/0,r=1/0;for(let t=0;t<s.count;t++){const e=s.getY(t);e>i&&(i=e),e<r&&(r=e)}return[r,i]}(t),u=s.simulateGroundPlane?function(t){const e=new THREE.Mesh(new THREE.PlaneGeometry(1e3,1e3),new THREE.MeshBasicMaterial({color:0,side:THREE.FrontSide,transparent:!0,opacity:.5}));return e.rotation.set(-Math.PI/2,0,0),e.position.setY(t-1),e.updateMatrix(),e.updateWorldMatrix(!1,!1),e}(c):null,d=t.mesh.geometry,p=d.clone(),m=new Ki(d,{indirect:!0,maxDepth:1e3,maxLeafTris:1}),y=function(t){const e=new Map;let s=0;for(let i in t.faces){const r=t.faces[i],n=r.vertices;n.length<3||(3===n.length?(e.set(s,r),s+=1):4===n.length&&(e.set(s,r),e.set(s+1,r),s+=2))}return{faceIndexToBlockbenchFace:e}}(t);try{for(const[e,r]of l){const{pixelsProcessed:n,facesProcessed:h}=await nr(e,r,t,u,m,y,s,i);a+=n,o+=h}return{anyMissing:r,anyWithTextures:n,totalPixelsProcessed:a,totalFacesProcessed:o}}finally{t.mesh.geometry=p}}async function nr(t,e,s,i,r,n,a,o){const h=new Map;let l=0;for(const t of e){const s=t.getOccupationMatrix(),c=t.getTexture();if(!c)continue;const u=c.width/c.uv_width,d=c.height/c.uv_height;if(u!==d)throw new Error(`Non-uniform pixel density detected for texture ${c.name}`);const p=[];Object.keys(s).forEach(t=>{Object.keys(s[t]).forEach(e=>{const i=s[t][e],r=parseInt(t,10),n=parseInt(e,10);if(!0===i)for(let t=0;t<u;t++)for(let e=0;e<d;e++)p.push([Math.floor(r*u+t),Math.floor(n*d+e)])})});let m=0;for(const[e,s]of p){const l=`${e},${s}`;let{x:c,y:p,z:y}=t.UVToLocal([(e+.5)/u,(s+.5)/d]);const f=or([c,p,y],0,t,0,i,r,n,a,hr(a.samples));if(f){const[t,e]=f,s=h.get(l);(!s||e<s.backfaceRatio)&&h.set(l,{color:t,backfaceRatio:e})}if(m++,m%32==0&&await new Promise(t=>setTimeout(t,0)),o.cancelled)throw new Error("Job cancelled")}l++,a?.onProgress?.(l/e.length)}let c=0;return t.edit(t=>{const e=t.getContext("2d");for(const[t,s]of h){const[i,r]=t.split(",").map(t=>parseInt(t,10));let[n,o,h,l]=s.color;a.retainTextureTransparency&&(l*=e.getImageData(i,r,1,1).data[3]/255),e.fillStyle=`rgba(${n}, ${o}, ${h}, ${l})`,e.fillRect(i,r,1,1),c++}}),{pixelsProcessed:c,facesProcessed:e.length}}Plugin.register("baked_ambient_occlusion",{title:"Mr Salmon's Baked Ambient Occlusion",author:"Kai Salmon",description:"Baked Ambient Occlusion, creating instant shading",icon:"icon.png",version:"1.0.0",min_version:"4.8.0",variant:"both",repository:"https://github.com/kaisalmon/MrSalmonsBlockbenchBakedAmbientOcclusion",has_changelog:!1,tags:["Texture","Shading"],onload(){tr=new Action("bake_ambient_occlusion",{name:"Bake Ambient Occlusion",description:"Perform ambient occlusion baking on selected meshes",icon:"cake",click:function(){ir()}}),MenuBar.addAction(tr,"filter")},onunload(){tr.delete()}});const ar={origin:new THREE.Vector3,direction:new THREE.Vector3,normal:new THREE.Vector3};function or(t,e,s,i,r,n,a,o,h){const[l,c,u]=t,[d,p,m]=s.getNormal(!0);ar.normal.set(d,p,m);let y=0,f=0;const x=o.samples;for(let t=0;t<x;t++){let e;ar.origin.set(l,c,u).addScaledVector(ar.normal,.5),"random"===o.sampleMethod?(ar.origin.x+=.5*(Math.random()-.5),ar.origin.y+=.5*(Math.random()-.5),ar.origin.z+=.5*(Math.random()-.5),ar.direction.set(2*(Math.random()-.5),2*(Math.random()-.5),2*(Math.random()-.5)).normalize(),e=ar.direction):e=h[t];const s=e.dot(ar.normal)>=0?o.aoShadowSize:o.aoHighlightSize,i=new THREE.Raycaster(ar.origin,e,.001,s),d=n.raycastFirst(i.ray,THREE.DoubleSide,.001,s);if(d){const t=d.face.normal;if(ar.direction.dot(t)>0&&(f+=1),o.sampleTextureTransparency){const t=a.faceIndexToBlockbenchFace.get(d.faceIndex);if(t){const[e,s]=t.localToUV(d.point),i=t.getTexture();y+=i?i.ctx.getImageData(e,s,1,1).data[3]/255:1}else y+=1}else y+=1}else r&&i.intersectObject(r).length>0&&(y+=1)}let g=1-y/x;const b=f/x;let w,_;return g<.5?(w=2*(.5-g),w=Math.pow(w,o.shadowGamma),_=o.shadowColor):(w=2*(g-.5),w=Math.pow(w,o.highlightGamma),_=o.highlightColor),[[_.r,_.g,_.b,_.a*w],b]}function hr(t){const e={},s=Math.PI*(3-Math.sqrt(5));for(let i=0;i<t;i++){const r=1-i/(t-1)*2,n=Math.sqrt(1-r*r),a=s*i;e[i]=new THREE.Vector3(n*Math.cos(a),r,n*Math.sin(a))}return e}return{}})());